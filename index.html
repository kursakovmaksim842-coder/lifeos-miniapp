<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeOS v8 Architect</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #020617;
            --card: rgba(15, 23, 42, 0.7);
            --primary: #3b82f6;
            --lava: #f97316;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text-main); font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding: 0; overflow-x: hidden; }

        /* --- NAV BAR --- */
        .tab-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 92%; height: 68px; background: rgba(15, 23, 42, 0.92);
            backdrop-filter: blur(25px); border-radius: 30px;
            display: flex; justify-content: space-around; align-items: center;
            border: 1px solid var(--border); z-index: 1000; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .tab-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sec); font-size: 10px; cursor: pointer; transition: 0.3s; }
        .tab-item.active { color: var(--primary); }
        .icon-circle { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 15px; margin-bottom: 2px; }
        .tab-item.active .icon-circle { background: var(--primary); color: white; box-shadow: 0 0 15px var(--primary); }

        /* --- UI COMPONENTS --- */
        .container { padding: 20px; padding-bottom: 120px; display: none; width: 100%; max-width: 500px; margin: 0 auto; }
        .container.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .glass-card { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 20px; margin-bottom: 15px; }
        .title-sm { font-size: 11px; font-weight: 800; color: var(--text-sec); text-transform: uppercase; letter-spacing: 1px; }
        .val-lg { font-size: 36px; font-weight: 800; color: var(--primary); margin: 5px 0; }

        /* --- LAVA WIDGET --- */
        .lava-box { width: 60px; height: 85px; background: #0f172a; border-radius: 15px; position: relative; overflow: hidden; border: 1px solid var(--border); }
        .lava-fill { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(0deg, #ea580c 0%, #fb923c 100%); transition: height 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .lava-fill::after { content: ""; position: absolute; top: -10px; left: -50%; width: 200%; height: 20px; background: rgba(251, 146, 60, 0.3); border-radius: 40%; animation: wave 3s infinite linear; }
        @keyframes wave { from { transform: translateX(0); } to { transform: translateX(50%); } }

        /* --- BUTTONS --- */
        .btn-p { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 16px; width: 100%; font-weight: 700; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .btn-p:active { transform: scale(0.98); opacity: 0.9; }
        .btn-sec { background: var(--glass); color: white; border: 1px solid var(--border); }

        /* --- HABITS --- */
        .bubble-row { display: flex; justify-content: space-between; margin: 15px 0; }
        .day-bubble { width: 34px; height: 34px; border-radius: 50%; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; background: var(--glass); }
        .day-bubble.active { background: var(--primary); border-color: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .progress-mini { height: 6px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden; margin-top: 10px; }
        .progress-bar { height: 100%; background: var(--primary); transition: 0.5s; }

        /* --- SETUP --- */
        #setup { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; flex-direction: column; justify-content: center; padding: 30px; }
        .inp { background: var(--card); border: 1px solid var(--border); color: white; padding: 18px; border-radius: 16px; width: 100%; margin-bottom: 12px; font-size: 16px; outline: none; }
    </style>
</head>
<body>

    <div id="setup">
        <h1 style="font-size: 28px; margin-bottom: 5px;">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</h1>
        <p style="color:var(--text-sec); margin-bottom: 25px;">–ù–∞—Å—Ç—Ä–æ–∏–º —Ç–≤–æ—é —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –∫—Ä–µ–ø–æ—Å—Ç—å.</p>
        <input type="number" id="inInc" class="inp" placeholder="–ú–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥ (‚ÇΩ)">
        <input type="number" id="inFix" class="inp" placeholder="–°—É–º–º–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å—á–µ—Ç–æ–≤ (‚ÇΩ)">
        <button class="btn-p" onclick="startApp()">–°–æ–∑–¥–∞—Ç—å LifeOS</button>
    </div>

    <div id="tab-fin" class="container active">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <div>
                <div class="title-sm">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ª–∏–º–∏—Ç / –¥–µ–Ω—å</div>
                <div class="val-lg" id="dailyShow">0 ‚ÇΩ</div>
            </div>
            <div class="lava-box">
                <div id="lava" class="lava-fill" style="height: 10%;"></div>
                <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:12px;"><span id="streakNum">1</span></div>
            </div>
        </div>

        <div class="glass-card" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div>
                <div class="title-sm">–ö–æ–ø–∏–ª–∫–∞ (20%)</div>
                <div id="saveVal" style="font-weight:700; color:var(--lava); margin-top:4px;">0 ‚ÇΩ</div>
            </div>
            <div>
                <div class="title-sm">–†–µ–∑–µ—Ä–≤ –Ω–∞ —Å—á–µ—Ç–∞</div>
                <div id="fixPoolVal" style="font-weight:700; color:var(--primary); margin-top:4px;">0 / 0 ‚ÇΩ</div>
            </div>
        </div>

        <div class="glass-card" style="background: linear-gradient(to right, rgba(59, 130, 246, 0.1), transparent); display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div class="title-sm">–û–ø–ª–∞—Ç–∞ —Å—á–µ—Ç–æ–≤</div>
                <div style="font-size:12px; color:var(--text-sec)">–°–ø–∏—à–µ—Ç—Å—è –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞</div>
            </div>
            <button onclick="payBill()" style="background:var(--primary); border:none; color:white; padding:8px 15px; border-radius:12px; font-weight:700; font-size:12px;">–û–ø–ª–∞—Ç–∏—Ç—å</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn-p btn-sec" onclick="modMoney(true)">+ –î–æ—Ö–æ–¥</button>
            <button class="btn-p" onclick="modMoney(false)">- –¢—Ä–∞—Ç–∞</button>
        </div>

        <h3 class="title-sm" style="margin: 25px 0 10px 0;">–ò—Å—Ç–æ—Ä–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
        <div id="txHistory"></div>
    </div>

    <div id="tab-hab" class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">–ó–∞–¥–∞—á–∏</h2>
            <button onclick="newHabit()" style="background:var(--primary); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:20px;">+</button>
        </div>

        <div id="habitList"></div>

        <div class="glass-card" style="margin-top:25px;">
            <div class="title-sm">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º</div>
            <p style="font-size:12px; color:var(--text-sec); margin-bottom:15px;">–†–µ–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ —Ç–≤–æ–µ–π –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.</p>
            <canvas id="habChart" height="180"></canvas>
        </div>
    </div>

    <div id="tab-ins" class="container">
        <h2 style="margin-bottom:20px;">–ò—Ç–æ–≥–∏</h2>
        
        <div class="glass-card">
            <h3 style="margin:0 0 15px 0;">–†–∞–¥–∞—Ä –î–∏—Å—Ü–∏–ø–ª–∏–Ω—ã</h3>
            <canvas id="radarChart"></canvas>
            <p style="font-size:12px; color:var(--text-sec); text-align:center; margin-top:15px;">–¢–≤–æ–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ –∏ —Ü–µ–ª—è–º–∏. –°—Ç—Ä–µ–º–∏—Å—å –∫ —Ä–æ–≤–Ω–æ–º—É –ø—è—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫—É!</p>
        </div>

        <div class="glass-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), transparent);">
            <div class="title-sm">–¢–≤–æ–π —Å—Ç—Ä–∏–∫ –≤–µ–¥–µ–Ω–∏—è</div>
            <div style="font-size:24px; font-weight:800; margin:10px 0;" id="streakLong">0 –î–Ω–µ–π</div>
            <div style="font-size:12px; color:var(--text-sec)">–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –º–µ—Å—è—Ü, —á—Ç–æ–±—ã –ª–∞–≤–∞ –¥–æ—Å—Ç–∏–≥–ª–∞ –≤–µ—Ä—Ö–∞ –∏ –æ—Ç–∫—Ä—ã–ª–∞ Premium-—Å—Ç–∞—Ç—É—Å.</div>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="sw('fin', this)">
            <div class="icon-circle">üèõ</div><span>–§–∏–Ω–∞–Ω—Å—ã</span>
        </div>
        <div class="tab-item" onclick="sw('hab', this)">
            <div class="icon-circle">‚ö°</div><span>–ó–∞–¥–∞—á–∏</span>
        </div>
        <div class="tab-item" onclick="sw('ins', this)">
            <div class="icon-circle">üìä</div><span>–ò—Ç–æ–≥–∏</span>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let db = {
        setup: false,
        incTotal: 0,
        fixTarget: 0,
        fixCurrent: 0,
        savings: 0,
        balance: 0,
        streak: 1,
        lastLog: new Date().toDateString(),
        txs: [],
        habits: [] // {id, name, goal, doneDates:[]}
    };

    const load = () => {
        const s = localStorage.getItem('lifeos_v8');
        if(s) db = JSON.parse(s);
        if(!db.setup) document.getElementById('setup').style.display = 'flex';
        else render();
    };

    const save = () => { localStorage.setItem('lifeos_v8', JSON.stringify(db)); render(); };

    function startApp() {
        const inc = +document.getElementById('inInc').value;
        const fix = +document.getElementById('inFix').value;
        if(!inc) return;
        db.incTotal = inc;
        db.fixTarget = fix;
        db.setup = true;
        distribute(inc);
        document.getElementById('setup').style.display = 'none';
        save();
    }

    function distribute(amount) {
        let s = Math.floor(amount * 0.2);
        db.savings += s;
        let rem = amount - s;
        let fixNeed = db.fixTarget - db.fixCurrent;
        if(fixNeed > 0) {
            let toFix = Math.min(rem, fixNeed);
            db.fixedCurrent += toFix;
            rem -= toFix;
        }
        db.balance += rem;
    }

    function modMoney(isInc) {
        if(isInc) {
            const v = +prompt("–°—É–º–º–∞ –¥–æ—Ö–æ–¥–∞:");
            if(v) distribute(v);
        } else {
            const v = +prompt("–°—É–º–º–∞ —Ç—Ä–∞—Ç—ã:");
            const c = prompt("–ö–∞—Ç–µ–≥–æ—Ä–∏—è:");
            if(v) {
                db.balance -= v;
                db.txs.unshift({id: Date.now(), val: v, cat: c || '–¢—Ä–∞—Ç–∞', t: new Date().toLocaleTimeString().slice(0,5)});
            }
        }
        checkStreak(); save();
    }

    function delTx(id) {
        const t = db.txs.find(x => x.id === id);
        db.balance += t.val;
        db.txs = db.txs.filter(x => x.id !== id);
        save();
    }

    function payBill() {
        const v = +prompt("–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ?");
        if(v && v <= db.fixedCurrent) {
            db.fixedCurrent -= v;
            tg.HapticFeedback.notificationOccurred('success');
            save();
        } else alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤ —Ä–µ–∑–µ—Ä–≤–µ!");
    }

    function checkStreak() {
        const today = new Date().toDateString();
        if(db.lastLog === today) return;
        const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
        db.streak = (db.lastLog === yesterday.toDateString()) ? db.streak + 1 : 1;
        db.lastLog = today;
    }

    function sw(id, el) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        if(id === 'ins' || id === 'hab') initCharts();
    }

    function render() {
        const days = new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate() - new Date().getDate() + 1;
        document.getElementById('dailyShow').innerText = Math.max(0, Math.floor(db.balance / days)).toLocaleString() + ' ‚ÇΩ';
        document.getElementById('saveVal').innerText = db.savings.toLocaleString() + ' ‚ÇΩ';
        document.getElementById('fixPoolVal').innerText = `${db.fixedCurrent.toLocaleString()} / ${db.fixTarget.toLocaleString()} ‚ÇΩ`;
        
        document.getElementById('lava').style.height = Math.min(100, (db.streak/30)*100) + '%';
        document.getElementById('streakNum').innerText = db.streak;
        document.getElementById('streakLong').innerText = db.streak + ' –î–Ω–µ–π';

        document.getElementById('txHistory').innerHTML = db.txs.slice(0, 5).map(t => `
            <div class="glass-card" style="display:flex; justify-content:space-between; align-items:center; padding:12px 18px; margin-bottom:8px;">
                <div><div style="font-weight:700;">${t.cat}</div><div style="font-size:10px; color:var(--text-sec);">${t.t}</div></div>
                <div style="display:flex; align-items:center; gap:12px;">
                    <span style="color:var(--lava); font-weight:800;">-${t.val} ‚ÇΩ</span>
                    <span onclick="delTx(${t.id})" style="font-size:16px;">üóë</span>
                </div>
            </div>
        `).join('');

        renderHabits();
    }

    function renderHabits() {
        const list = document.getElementById('habitList');
        list.innerHTML = '';
        db.habits.forEach(h => {
            const current = h.doneDates.length;
            const pct = Math.min(100, (current / h.goal) * 100);
            const daysArr = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
            let bubbles = '';
            daysArr.forEach((d, i) => {
                const date = getWeekDate(i);
                const act = h.doneDates.includes(date) ? 'active' : '';
                bubbles += `<div class="day-bubble ${act}" onclick="togHab(${h.id}, '${date}')">${d}</div>`;
            });

            list.innerHTML += `
                <div class="glass-card">
                    <div style="display:flex; justify-content:space-between;">
                        <span style="font-weight:800;">${h.name}</span>
                        <span style="font-size:12px; font-weight:700; color:var(--primary);">${current} / ${h.goal}</span>
                    </div>
                    <div class="bubble-row">${bubbles}</div>
                    <div class="progress-mini"><div class="progress-bar" style="width:${pct}%"></div></div>
                </div>
            `;
        });
    }

    function getWeekDate(i) {
        const d = new Date(); const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1) + i;
        return new Date(d.setDate(diff)).toDateString();
    }

    function togHab(id, date) {
        const h = db.habits.find(x => x.id === id);
        if(h.doneDates.includes(date)) h.doneDates = h.doneDates.filter(d => d !== date);
        else { h.doneDates.push(date); tg.HapticFeedback.impactOccurred('light'); }
        save();
    }

    function newHabit() {
        const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:");
        const g = +prompt("–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –º–µ—Å—è—Ü –ø–ª–∞–Ω–∏—Ä—É–µ—à—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å?");
        if(n && g) { db.habits.push({id: Date.now(), name: n, goal: g, doneDates: []}); save(); }
    }

    function initCharts() {
        const habCtx = document.getElementById('habChart')?.getContext('2d');
        const radCtx = document.getElementById('radarChart')?.getContext('2d');
        if(!habCtx || !radCtx) return;

        // –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ–¥–µ–ª–∏
        const counts = [0,0,0,0,0,0,0];
        db.habits.forEach(h => {
            h.doneDates.forEach(d => {
                const day = new Date(d).getDay();
                counts[day === 0 ? 6 : day - 1]++;
            });
        });

        new Chart(habCtx, {
            type: 'bar',
            data: {
                labels: ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'],
                datasets: [{ data: counts, backgroundColor: '#3b82f6', borderRadius: 6 }]
            },
            options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
        });

        new Chart(radCtx, {
            type: 'radar',
            data: {
                labels: ['–§–∏–Ω–∞–Ω—Å—ã', '–ó–∞–¥–∞—á–∏', '–°—Ç—Ä–∏–∫', '–°–±–µ—Ä–µ–∂–µ–Ω–∏—è', '–°—á–µ—Ç–∞'],
                datasets: [{
                    data: [80, 60, (db.streak/30)*100, 90, (db.fixedCurrent/db.fixTarget)*100],
                    backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: '#3b82f6', pointRadius: 0
                }]
            },
            options: { scales: { r: { display: false } }, plugins: { legend: { display: false } } }
        });
    }

    load();
</script>
</body>
</html>
