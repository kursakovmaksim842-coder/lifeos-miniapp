<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeOS v16 Ethereal</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg: #050505;
            --card-bg: rgba(28, 28, 30, 0.6);
            --card-border: rgba(255, 255, 255, 0.08);
            --primary: #FFFFFF;
            --secondary: #86868b;
            --accent: #0A84FF;
            --gold: #D4AF37; /* Premium Gold */
            --danger: #FF453A;
            --success: #30D158;
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            background-color: var(--bg);
            /* Эффект глубокого космоса/люкса */
            background-image: radial-gradient(circle at 50% -20%, #1a1a2e 0%, #000000 60%);
            color: var(--primary); 
            font-family: var(--font-stack); 
            margin: 0; padding: 0; 
            min-height: 100vh; overflow-x: hidden;
        }

        /* --- TYPOGRAPHY --- */
        .display-text { font-size: 48px; font-weight: 700; letter-spacing: -1.5px; line-height: 1.1; }
        .h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; margin: 0; }
        .h2 { font-size: 17px; font-weight: 600; letter-spacing: -0.3px; color: var(--primary); }
        .sub { font-size: 13px; color: var(--secondary); font-weight: 500; }
        .label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--secondary); font-weight: 700; margin-bottom: 8px; display: block; }

        /* --- CARDS (GLASSMORPHISM) --- */
        .lux-card {
            background: var(--card-bg);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 16px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        /* --- HEADER & STATUS --- */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding: 0 4px; }
        
        .status-badge {
            background: rgba(255,255,255,0.1);
            padding: 6px 12px; border-radius: 100px;
            font-size: 12px; font-weight: 600;
            display: flex; align-items: center; gap: 6px;
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--gold);
        }
        .status-dot { width: 6px; height: 6px; background: var(--gold); border-radius: 50%; box-shadow: 0 0 10px var(--gold); }

        /* --- BUTTONS --- */
        .btn-row { display: flex; gap: 12px; margin-bottom: 30px; }
        .lux-btn {
            flex: 1; padding: 16px; border-radius: 18px; border: none;
            font-size: 16px; font-weight: 600; cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-glass { background: rgba(255,255,255,0.1); color: #fff; }
        .lux-btn:active { transform: scale(0.97); }

        /* --- HABIT TRACKER (WEEKLY STRIP) --- */
        .habit-card {
            background: rgba(20, 20, 22, 0.8);
            border-radius: 20px; padding: 16px; margin-bottom: 12px;
            border: 1px solid var(--card-border);
        }
        .habit-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-btn {
            aspect-ratio: 1; border-radius: 50%;
            background: rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700; color: var(--secondary);
            cursor: pointer; transition: 0.2s;
        }
        .day-btn.active { background: var(--success); color: #000; box-shadow: 0 0 15px rgba(48, 209, 88, 0.4); }
        .day-btn.today { border: 1px solid var(--secondary); }

        /* --- DATE PICKER HIDDEN --- */
        input[type="date"] {
            background: transparent; border: none; color: white;
            font-family: inherit; font-size: 14px;
            opacity: 0; position: absolute; z-index: -1;
        }

        /* --- TABS --- */
        .tab-view { display: none; padding: 20px 20px 100px 20px; max-width: 500px; margin: 0 auto; }
        .tab-view.active { display: block; animation: smoothFade 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes smoothFade { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* --- NAVIGATION --- */
        .nav-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 380px; height: 65px;
            background: rgba(22, 22, 22, 0.9); backdrop-filter: blur(50px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 32px;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100; box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }
        .nav-item { opacity: 0.4; transition: 0.3s; padding: 10px; cursor: pointer; }
        .nav-item.active { opacity: 1; transform: scale(1.1); }

        /* --- LISTS --- */
        .tx-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .tx-item:last-child { border: none; }
    </style>
</head>
<body>

    <input type="date" id="hiddenDateInput">

    <div id="setupView" style="position:fixed; inset:0; z-index:5000; background:#000; display:none; padding:40px; flex-direction:column; justify-content:center;">
        <h1 class="h1" style="font-size:32px; margin-bottom:10px;">Настройка</h1>
        <p class="sub" style="margin-bottom:40px;">Введите базовые данные для старта.</p>
        <input type="number" id="setupBal" placeholder="Баланс сейчас (₽)" style="background:rgba(255,255,255,0.1); padding:20px; border-radius:16px; border:none; color:white; font-size:18px; margin-bottom:15px; width:100%;">
        <input type="number" id="setupFix" placeholder="Обязательные траты (₽)" style="background:rgba(255,255,255,0.1); padding:20px; border-radius:16px; border:none; color:white; font-size:18px; margin-bottom:15px; width:100%;">
        <div class="label">Дата зарплаты</div>
        <input type="date" id="setupDate" style="position:relative; opacity:1; background:rgba(255,255,255,0.1); padding:20px; border-radius:16px; border:none; color:white; width:100%;">
        <button onclick="finishSetup()" class="lux-btn btn-primary" style="margin-top:30px;">Запустить LifeOS</button>
    </div>

    <div id="view-fin" class="tab-view active">
        <div class="header-row">
            <div class="sub" style="font-size:11px; opacity:0.7;">LIFEOS PREMIUM</div>
            <div class="status-badge" onclick="showRankInfo()">
                <div class="status-dot"></div>
                <span id="rankBadge">MEMBER</span>
            </div>
        </div>

        <div style="margin-bottom: 30px;">
            <div class="label" style="margin-bottom: 4px;">Дневной лимит</div>
            <div class="display-text" id="dailyDisplay">0 ₽</div>
            <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
                <span class="sub" id="daysLeftDisplay">До з/п ...</span>
                <span onclick="triggerDateChange()" style="font-size:11px; color:var(--accent); font-weight:600; cursor:pointer; background:rgba(10,132,255,0.1); padding:2px 8px; border-radius:6px;">ИЗМЕНИТЬ</span>
            </div>
        </div>

        <div class="lux-card" style="display:flex; gap:20px;">
            <div style="flex:1;">
                <div class="label" style="color:var(--gold);">Накопления</div>
                <div class="h2" id="safeDisplay">0 ₽</div>
            </div>
            <div style="width:1px; background:rgba(255,255,255,0.1);"></div>
            <div style="flex:1;">
                <div class="label">Обязательные</div>
                <div class="h2" id="fixedDisplay">0 / 0</div>
            </div>
        </div>

        <div class="btn-row">
            <button onclick="addIncome()" class="lux-btn btn-glass" style="color:var(--success);">+ Пополнить</button>
            <button onclick="addExpense()" class="lux-btn btn-primary">- Потратить</button>
        </div>

        <div class="label">Транзакции</div>
        <div class="lux-card" style="padding: 10px 24px;" id="txContainer"></div>
    </div>

    <div id="view-hab" class="tab-view">
        <div class="header-row">
            <h1 class="h1">Привычки</h1>
            <div onclick="addHabit()" style="width:32px; height:32px; background:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:black; font-size:20px;">+</div>
        </div>
        <div id="habitsContainer"></div>
    </div>

    <div id="view-ins" class="tab-view">
        <h1 class="h1" style="margin-bottom:20px;">Аналитика</h1>
        
        <div class="lux-card">
            <div class="label">Эффективность</div>
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div class="h1" id="streakVal">0 дн</div>
                <div class="sub">Текущая серия (Стрик)</div>
            </div>
        </div>

        <div class="lux-card">
            <div class="label" style="margin-bottom:15px;">Баланс жизни</div>
            <canvas id="radarCanvas"></canvas>
        </div>

        <div class="lux-btn btn-glass" style="text-align:center; color:var(--danger); margin-top:40px;" onclick="resetData()">
            Сброс данных
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="go('fin', this)">●</div>
        <div class="nav-item" onclick="go('hab', this)">●</div>
        <div class="nav-item" onclick="go('ins', this)">●</div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // STATE
    let db = {
        setup: false, balance: 0, fixedTotal: 0, fixedPaid: 0,
        savings: 0, salaryDate: null, txs: [], habits: [], streak: 0, lastLog: ''
    };

    // INIT
    function init() {
        const s = localStorage.getItem('lifeos_ethereal');
        if(s) db = JSON.parse(s);
        
        if(!db.setup) {
            document.getElementById('setupView').style.display = 'flex';
        } else {
            updateStreak();
            render();
        }

        // Setup hidden date listener
        document.getElementById('hiddenDateInput').addEventListener('change', (e) => {
            if(e.target.value) {
                db.salaryDate = e.target.value;
                save();
            }
        });
    }

    function save() {
        localStorage.setItem('lifeos_ethereal', JSON.stringify(db));
        render();
    }

    function finishSetup() {
        db.balance = +document.getElementById('setupBal').value;
        db.fixedTotal = +document.getElementById('setupFix').value;
        db.salaryDate = document.getElementById('setupDate').value;
        if(!db.salaryDate) return alert("Введите дату!");
        db.setup = true;
        save();
        document.getElementById('setupView').style.display = 'none';
    }

    // CORE LOGIC
    function updateStreak() {
        const today = new Date().toDateString();
        if(db.lastLog !== today) {
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            db.streak = (db.lastLog === yesterday) ? db.streak + 1 : 1;
            db.lastLog = today;
            save();
        }
    }

    function addIncome() {
        const val = +prompt("Сумма дохода:");
        if(!val) return;
        
        // Luxury Split Logic
        const toSave = Math.floor(val * 0.2); // 20%
        const neededFixed = Math.max(0, db.fixedTotal - db.fixedPaid);
        const toFixed = Math.min(val - toSave, neededFixed);
        const toBal = val - toSave - toFixed;

        db.savings += toSave;
        db.fixedPaid += toFixed;
        db.balance += toBal;

        db.txs.unshift({
            id: Date.now(), type: 'inc', val: val, 
            desc: 'Пополнение', date: new Date().toLocaleDateString(),
            split: {s: toSave, f: toFixed, b: toBal}
        });
        save();
    }

    function addExpense() {
        const val = +prompt("Сумма траты:");
        if(!val) return;
        const desc = prompt("На что?") || "Трата";
        
        db.balance -= val;
        db.txs.unshift({
            id: Date.now(), type: 'exp', val: val, 
            desc: desc, date: new Date().toLocaleDateString()
        });
        save();
    }

    function removeTx(id) {
        if(!confirm("Удалить запись?")) return;
        const idx = db.txs.findIndex(t => t.id === id);
        if(idx === -1) return;
        const t = db.txs[idx];

        if(t.type === 'inc') {
            db.savings -= t.split.s;
            db.fixedPaid -= t.split.f;
            db.balance -= t.split.b;
        } else {
            db.balance += t.val;
        }
        db.txs.splice(idx, 1);
        save();
    }

    function triggerDateChange() {
        const input = document.getElementById('hiddenDateInput');
        input.value = db.salaryDate;
        input.showPicker(); // Opens Native Date Picker
    }

    // HABITS
    function addHabit() {
        const name = prompt("Название привычки:");
        if(name) {
            db.habits.push({ id: Date.now(), name: name, goal: 30, history: [] });
            save();
        }
    }

    function toggleHabit(id, offset) {
        const d = new Date();
        d.setDate(d.getDate() - ((d.getDay() + 6) % 7) + offset); // Get correct date based on Mon-Sun
        const key = d.toDateString();
        
        const h = db.habits.find(x => x.id === id);
        if(h.history.includes(key)) h.history = h.history.filter(k => k !== key);
        else h.history.push(key);
        
        save(); // Will re-render
    }

    // RENDER
    function render() {
        // 1. Finance
        const now = new Date(); now.setHours(0,0,0,0);
        const target = new Date(db.salaryDate); target.setHours(0,0,0,0);
        let days = Math.ceil((target - now) / (1000 * 3600 * 24));
        if(days < 1) days = 1;

        // Calc Daily
        const todayStr = new Date().toLocaleDateString();
        const spentToday = db.txs.filter(t => t.type === 'exp' && t.date === todayStr).reduce((a,b)=>a+b.val,0);
        const safeBal = Math.max(0, db.balance);
        const daily = Math.floor((safeBal + spentToday) / days) - spentToday;

        document.getElementById('dailyDisplay').innerText = daily.toLocaleString() + ' ₽';
        document.getElementById('daysLeftDisplay').innerText = `До зарплаты ${days} дн.`;
        document.getElementById('safeDisplay').innerText = db.savings.toLocaleString() + ' ₽';
        document.getElementById('fixedDisplay').innerText = `${db.fixedPaid} / ${db.fixedTotal}`;
        
        // Rank
        const score = db.streak + db.txs.length;
        let rank = "MEMBER";
        if(score > 50) rank = "SILVER";
        if(score > 150) rank = "GOLD";
        if(score > 300) rank = "PLATINUM";
        document.getElementById('rankBadge').innerText = rank;
        if(rank === 'GOLD') document.querySelector('.status-dot').style.boxShadow = '0 0 15px gold';

        // Txs
        const txHtml = db.txs.slice(0, 5).map(t => `
            <div class="tx-item">
                <div>
                    <div class="h2" style="font-size:15px; margin-bottom:2px;">${t.desc}</div>
                    <div class="sub">${t.date}</div>
                </div>
                <div style="text-align:right;">
                    <div style="color:${t.type==='inc'?'var(--success)':'var(--primary)'}; font-weight:600;">
                        ${t.type==='inc'?'+':'-'}${t.val}
                    </div>
                    <div onclick="removeTx(${t.id})" style="font-size:10px; color:var(--danger); opacity:0.5; margin-top:4px;">✕</div>
                </div>
            </div>
        `).join('');
        document.getElementById('txContainer').innerHTML = txHtml || '<div class="sub" style="text-align:center; padding:10px;">История пуста</div>';

        // 2. Habits (Weekly View)
        renderHabits();

        // 3. Insights
        document.getElementById('streakVal').innerText = db.streak + " дн";
        drawRadar();
    }

    function renderHabits() {
        const con = document.getElementById('habitsContainer');
        const todayDay = (new Date().getDay() + 6) % 7; // 0=Mon, 6=Sun

        con.innerHTML = db.habits.map(h => {
            let weekHtml = '';
            for(let i=0; i<7; i++) {
                // Calc date for button
                const d = new Date();
                const currentDay = (d.getDay() + 6) % 7;
                d.setDate(d.getDate() - currentDay + i);
                const key = d.toDateString();
                
                const active = h.history.includes(key);
                const isToday = i === todayDay;
                const letter = ['П','В','С','Ч','П','С','В'][i];

                weekHtml += `<div class="day-btn ${active?'active':''} ${isToday?'today':''}" 
                             onclick="toggleHabit(${h.id}, ${i})">${letter}</div>`;
            }

            return `
            <div class="habit-card">
                <div class="habit-header">
                    <span class="h2">${h.name}</span>
                    <span class="sub">${h.history.length} вып.</span>
                </div>
                <div class="week-grid">${weekHtml}</div>
            </div>`;
        }).join('');
    }

    function drawRadar() {
        const ctx = document.getElementById('radarCanvas').getContext('2d');
        if(window.myRadar) window.myRadar.destroy();
        window.myRadar = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['Дисциплина', 'Финансы', 'Здоровье', 'Ум'],
                datasets: [{
                    data: [85, 70, 60, 90], // Demo data
                    backgroundColor: 'rgba(255, 255, 255, 0.1)',
                    borderColor: '#fff',
                    borderWidth: 1,
                    pointRadius: 0
                }]
            },
            options: {
                scales: { r: { grid: { color:'rgba(255,255,255,0.05)' }, ticks: { display:false }, pointLabels: { color:'#86868b' } } },
                plugins: { legend: false }
            }
        });
    }

    function go(tab, el) {
        document.querySelectorAll('.tab-view').forEach(t => t.classList.remove('active'));
        document.getElementById('view-'+tab).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        if(tab === 'ins') setTimeout(drawRadar, 100);
    }
    
    function resetData() { if(confirm("Сброс?")) { localStorage.clear(); location.reload(); } }
    function showRankInfo() { alert("Ваш уровень доступа повышается при регулярном использовании."); }

    init();
</script>
</body>
</html>
