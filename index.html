<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeOS v4 Blue</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #050505; /* –ü–æ—á—Ç–∏ —á–µ—Ä–Ω—ã–π */
            --card-bg: #141416;
            --primary: #3b82f6; /* –ü—Ä–∏—è—Ç–Ω—ã–π —Å–∏–Ω–∏–π */
            --primary-glow: rgba(59, 130, 246, 0.4);
            --danger: #ef4444;
            --text-main: #ffffff;
            --text-sec: #94a3b8;
            --radius: 20px;
            --nav-height: 70px;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- UI COMPONENTS --- */
        .container { padding: 20px; padding-bottom: 100px; display: none; animation: fadeIn 0.3s ease; }
        .container.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--card-bg); border-radius: var(--radius); padding: 20px;
            margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .btn {
            background: var(--primary); color: white; border: none; padding: 14px;
            border-radius: 14px; width: 100%; font-weight: 600; font-size: 16px;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn-red { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }

        /* --- NAVIGATION --- */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            background: rgba(20, 20, 22, 0.85); backdrop-filter: blur(20px);
            border-radius: 24px; height: 64px; display: flex; justify-content: space-around; align-items: center;
            border: 1px solid rgba(255,255,255,0.08); z-index: 1000; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: var(--text-sec); font-size: 11px; cursor: pointer; transition: 0.3s;
        }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }

        /* --- ONBOARDING --- */
        #setupWizard {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 2000; display: none; flex-direction: column;
            padding: 30px; box-sizing: border-box; justify-content: center;
        }
        .step-title { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
        .input-big {
            background: transparent; border: none; border-bottom: 2px solid var(--primary);
            color: white; font-size: 32px; width: 100%; text-align: center; padding: 10px; margin: 30px 0; outline: none;
        }

        /* --- FINANCE TAB --- */
        .money-hero { text-align: center; padding: 10px 0; }
        .money-amount { font-size: 48px; font-weight: 800; letter-spacing: -1px; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .money-label { font-size: 13px; color: var(--text-sec); text-transform: uppercase; letter-spacing: 1px; }
        
        /* --- HABITS TAB --- */
        .habit-item {
            background: rgba(255,255,255,0.03); padding: 16px; border-radius: 16px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent;
        }
        .habit-item.done { border-color: rgba(59, 130, 246, 0.3); background: rgba(59, 130, 246, 0.05); }
        .checkbox {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--text-sec);
            display: flex; align-items: center; justify-content: center; transition: 0.3s;
        }
        .habit-item.done .checkbox { background: var(--primary); border-color: var(--primary); color: white; }
        
        .week-days { display: flex; gap: 8px; justify-content: center; margin: 20px 0; }
        .day-circle {
            width: 36px; height: 36px; border-radius: 50%; background: #222; color: #666;
            display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer;
        }
        .day-circle.selected { background: var(--primary); color: white; box-shadow: 0 0 10px var(--primary-glow); }

        /* --- STATS TAB --- */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .stat-num { font-size: 24px; font-weight: 700; color: var(--primary); }
    </style>
</head>
<body>

    <div id="setupWizard">
        <div id="step1">
            <div class="step-title">–®–∞–≥ 1: –î–æ—Ö–æ–¥</div>
            <p style="color:var(--text-sec)">–°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –¥–µ–Ω–µ–≥ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –º–µ—Å—è—Ü?</p>
            <input type="number" id="incomeInput" class="input-big" placeholder="0 ‚ÇΩ">
            <button class="btn" onclick="nextStep(2)">–î–∞–ª–µ–µ ‚Üí</button>
        </div>
        <div id="step2" style="display:none;">
            <div class="step-title">–®–∞–≥ 2: –û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞</div>
            <p style="color:var(--text-sec)">–ê—Ä–µ–Ω–¥–∞, –∫—Ä–µ–¥–∏—Ç—ã, —Å–≤—è–∑—å, –∫–æ–º–º—É–Ω–∞–ª–∫–∞. –°—É–º–º–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π:</p>
            <input type="number" id="fixedInput" class="input-big" placeholder="0 ‚ÇΩ">
            <button class="btn" onclick="finishSetup()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –±—é–¥–∂–µ—Ç üöÄ</button>
        </div>
    </div>

    <div id="tab-finance" class="container active">
        <div class="money-hero">
            <div class="money-label">–°–µ–≥–æ–¥–Ω—è –º–æ–∂–Ω–æ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å</div>
            <div class="money-amount" id="dailyLimitDisplay">0 ‚ÇΩ</div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; color:var(--text-sec); font-size:12px; margin-bottom:10px;">
                <span>–û—Å—Ç–∞—Ç–æ–∫ –º–µ—Å: <b id="balanceDisplay" style="color:#fff">0</b></span>
                <span>–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è (20%): <b id="savingsDisplay" style="color:var(--primary)">0</b></span>
            </div>
            <div style="background:rgba(255,255,255,0.1); height:6px; border-radius:3px; overflow:hidden;">
                <div id="financeBar" style="height:100%; width:100%; background:var(--primary); transition:0.5s;"></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                <button class="btn" onclick="logExpense(false)">‚úÖ –í –±—é–¥–∂–µ—Ç–µ</button>
                <button class="btn btn-red" onclick="logExpense(true)">üí∏ –†–∞—Å—Ö–æ–¥</button>
            </div>
        </div>

        <h3 style="margin-left:5px;">–ò—Å—Ç–æ—Ä–∏—è —Å–µ–≥–æ–¥–Ω—è</h3>
        <div id="txList"></div>
    </div>

    <div id="tab-habits" class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>–¢–≤–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏</h2>
            <button onclick="toggleAddHabit()" style="background:var(--card-bg); border:1px solid rgba(255,255,255,0.1); color:white; width:36px; height:36px; border-radius:50%; font-size:20px;">+</button>
        </div>

        <div id="addHabitBlock" class="card" style="display:none;">
            <input id="newHabitName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –ß—Ç–µ–Ω–∏–µ)" style="width:100%; background:transparent; border:none; border-bottom:1px solid #333; color:white; padding:10px; outline:none;">
            <div class="week-days" id="daySelector"></div>
            <button class="btn" onclick="saveHabit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        </div>

        <div id="habitsList">
            </div>
    </div>

    <div id="tab-stats" class="container">
        <h2>–¢–≤–æ—è –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
        
        <div class="stat-grid">
            <div class="stat-box">
                <div class="stat-num" id="disciplineScore">0%</div>
                <div style="font-size:12px; color:var(--text-sec)">–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞</div>
            </div>
            <div class="stat-box">
                <div class="stat-num" id="tasksDoneTotal">0</div>
                <div style="font-size:12px; color:var(--text-sec)">–ó–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0">–§–∏–Ω–∞–Ω—Å—ã vs –ü—Ä–∏–≤—ã—á–∫–∏</h3>
            <canvas id="mainChart" height="200"></canvas>
        </div>
        
        <button class="btn btn-red" onclick="fullReset()" style="margin-top:30px;">‚ö†Ô∏è –°–±—Ä–æ—Å –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö</button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('finance', this)">
            <span class="nav-icon">üí≥</span>
            <span>–§–∏–Ω–∞–Ω—Å—ã</span>
        </div>
        <div class="nav-item" onclick="switchTab('habits', this)">
            <span class="nav-icon">üî•</span>
            <span>–ü—Ä–∏–≤—ã—á–∫–∏</span>
        </div>
        <div class="nav-item" onclick="switchTab('stats', this)">
            <span class="nav-icon">üìä</span>
            <span>–ò—Ç–æ–≥–∏</span>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    // --- –î–ê–ù–ù–´–ï –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
    let db = {
        setup: false,
        income: 0,
        fixed: 0,
        savings: 0, // 20%
        dailyBudget: 0, // –†–∞—Å—á–µ—Ç–Ω—ã–π
        balance: 0, // –¢–µ–∫—É—â–∏–π
        spentToday: 0,
        history: [],
        habits: [], // {id, name, days:[], doneDates:[]}
        stats: { daysTracked: 0, totalDone: 0 }
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞
    const saved = localStorage.getItem('lifeos_v4_blue');
    if(saved) db = JSON.parse(saved);

    // --- –õ–û–ì–ò–ö–ê ONBOARDING ---
    if(!db.setup) {
        document.getElementById('setupWizard').style.display = 'flex';
    } else {
        updateAllUI();
    }

    function nextStep(n) {
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'block';
    }

    function finishSetup() {
        const income = +document.getElementById('incomeInput').value;
        const fixed = +document.getElementById('fixedInput').value;
        
        if(!income) return alert('–ù—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –¥–æ—Ö–æ–¥');

        db.income = income;
        db.fixed = fixed;
        db.savings = Math.floor(income * 0.20); // 20% –∫–æ–ø–∏–º
        
        // –§–æ—Ä–º—É–ª–∞: (–î–æ—Ö–æ–¥ - –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è - –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ) / 30 –¥–Ω–µ–π
        const freeMoney = income - db.savings - db.fixed;
        db.dailyBudget = Math.floor(freeMoney / 30);
        
        // –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —Å—Ç–∞–≤–∏–º –∫–∞–∫ –≤–µ—Å—å —Å–≤–æ–±–æ–¥–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –±—É–¥–µ–º –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç
        db.balance = freeMoney;
        db.setup = true;
        
        save();
        document.getElementById('setupWizard').style.display = 'none';
        updateAllUI();
    }

    // --- UI –õ–û–ì–ò–ö–ê ---
    function switchTab(tabId, el) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');

        if(tabId === 'stats') renderChart();
    }

    function updateAllUI() {
        // –§–∏–Ω–∞–Ω—Å—ã
        const todayLimit = db.dailyBudget - db.spentToday;
        document.getElementById('dailyLimitDisplay').innerText = todayLimit.toLocaleString() + ' ‚ÇΩ';
        document.getElementById('balanceDisplay').innerText = db.balance.toLocaleString() + ' ‚ÇΩ';
        document.getElementById('savingsDisplay').innerText = db.savings.toLocaleString() + ' ‚ÇΩ';
        
        // –ë–∞—Ä –±—é–¥–∂–µ—Ç–∞
        const pct = Math.max(0, (todayLimit / db.dailyBudget) * 100);
        const bar = document.getElementById('financeBar');
        bar.style.width = pct + '%';
        bar.style.background = pct < 20 ? '#ef4444' : '#3b82f6';

        // –ü—Ä–∏–≤—ã—á–∫–∏
        renderHabitsList();

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        document.getElementById('tasksDoneTotal').innerText = db.stats.totalDone;
        // –†–∞—Å—á–µ—Ç –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã (–ø—Ä–∏–º–µ—Ä–Ω—ã–π)
        const habitsTotal = db.habits.length * 7; // —É—Å–ª–æ–≤–Ω–æ –∑–∞–¥–∞—á –≤ –Ω–µ–¥–µ–ª—é
        const score = habitsTotal ? Math.round((db.stats.totalDone / habitsTotal) * 100) : 0; // —É–ø—Ä–æ—â–µ–Ω–æ
        document.getElementById('disciplineScore').innerText = Math.min(100, score + (db.spentToday < db.dailyBudget ? 10 : 0)) + '%';
    }

    // --- –§–ò–ù–ê–ù–°–´ ---
    function logExpense(isRealExpense) {
        tg.HapticFeedback.impactOccurred('light');
        if(isRealExpense) {
            const amount = +prompt("–°—É–º–º–∞ —Ç—Ä–∞—Ç—ã (‚ÇΩ):");
            if(!amount) return;
            
            db.spentToday += amount;
            db.balance -= amount;
            
            db.history.unshift({t: new Date().toLocaleTimeString().slice(0,5), val: amount});
        } else {
            tg.showPopup({title:'–°—É–ø–µ—Ä!', message:'–¢—ã –¥–µ—Ä–∂–∏—à—å—Å—è –≤ –±—é–¥–∂–µ—Ç–µ.'});
        }
        save();
        updateAllUI();
        renderHistory();
    }

    function renderHistory() {
        const list = document.getElementById('txList');
        list.innerHTML = db.history.slice(0,3).map(x => 
            `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #333; font-size:14px;">
                <span>–¢—Ä–∞—Ç–∞</span>
                <span style="color:#ef4444">-${x.val} ‚ÇΩ</span>
            </div>`
        ).join('');
    }

    // --- –ü–†–ò–í–´–ß–ö–ò ---
    // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
    const daysArr = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
    let selectedDays = [];
    const ds = document.getElementById('daySelector');
    daysArr.forEach((d, i) => {
        const el = document.createElement('div');
        el.className = 'day-circle';
        el.innerText = d;
        el.onclick = () => {
            el.classList.toggle('selected');
            const idx = i === 6 ? 0 : i + 1; // JS Date: 0=Sun, but here 0=Pn logic adjustment
            if(selectedDays.includes(i)) selectedDays = selectedDays.filter(x => x!==i);
            else selectedDays.push(i);
        };
        ds.appendChild(el);
    });

    function toggleAddHabit() {
        const b = document.getElementById('addHabitBlock');
        b.style.display = b.style.display === 'none' ? 'block' : 'none';
    }

    function saveHabit() {
        const name = document.getElementById('newHabitName').value;
        if(!name || !selectedDays.length) return alert('–ó–∞–ø–æ–ª–Ω–∏ –∏–º—è –∏ –¥–Ω–∏');
        
        db.habits.push({
            id: Date.now(),
            name,
            days: selectedDays, // –ò–Ω–¥–µ–∫—Å—ã 0..6
            doneDates: []
        });
        save();
        toggleAddHabit();
        updateAllUI();
    }

    function renderHabitsList() {
        const list = document.getElementById('habitsList');
        list.innerHTML = '';
        const todayIdx = (new Date().getDay() + 6) % 7; // –î–µ–ª–∞–µ–º –ü–Ω=0, –í—Å=6
        const todayStr = new Date().toDateString();

        // –§–∏–ª—å—Ç—Ä: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –Ω—É–∂–Ω—ã
        const todayHabits = db.habits.filter(h => h.days.includes(todayIdx));

        if(!todayHabits.length) list.innerHTML = '<div style="text-align:center; color:#555; margin-top:20px">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–¥–∞—á –Ω–µ—Ç üéâ</div>';

        todayHabits.forEach(h => {
            const isDone = h.doneDates.includes(todayStr);
            // –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –≤—Å–µ–≥–æ
            const totalCount = h.doneDates.length; 
            
            list.innerHTML += `
            <div class="habit-item ${isDone?'done':''}" onclick="checkHabit(${h.id})">
                <div>
                    <div style="font-weight:600">${h.name}</div>
                    <div style="font-size:12px; color:var(--text-sec)">–í—ã–ø–æ–ª–Ω–µ–Ω–æ —Ä–∞–∑: ${totalCount}</div>
                </div>
                <div class="checkbox">${isDone?'‚úî':''}</div>
            </div>`;
        });
    }

    function checkHabit(id) {
        const h = db.habits.find(x => x.id === id);
        const todayStr = new Date().toDateString();
        
        if(h.doneDates.includes(todayStr)) {
            h.doneDates = h.doneDates.filter(d => d !== todayStr);
            db.stats.totalDone--;
        } else {
            h.doneDates.push(todayStr);
            db.stats.totalDone++;
            tg.HapticFeedback.notificationOccurred('success');
        }
        save();
        updateAllUI();
    }

    // --- CHART & SYSTEM ---
    function renderChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è', '–ü–æ—Ç—Ä–∞—á–µ–Ω–æ', '–û—Å—Ç–∞—Ç–æ–∫'],
                datasets: [{
                    data: [db.savings, db.income - db.balance, db.balance],
                    backgroundColor: ['#3b82f6', '#ef4444', '#10b981'],
                    borderWidth: 0
                }]
            },
            options: { cutout: '70%', plugins: { legend: { position: 'bottom', labels:{color:'#fff'} } } }
        });
    }

    function save() { localStorage.setItem('lifeos_v4_blue', JSON.stringify(db)); }
    function fullReset() { localStorage.removeItem('lifeos_v4_blue'); location.reload(); }

</script>
</body>
</html>
