<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeOS V3</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #000000;
            --card-bg: #1c1c1e;
            --primary: #32d74b;
            --danger: #ff453a;
            --text-main: #ffffff;
            --text-sec: #8e8e93;
            --radius: 16px;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 20px; padding-bottom: 100px;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .fade-in { animation: slideUp 0.4s ease-out forwards; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background: var(--card-bg); border-radius: var(--radius); padding: 20px;
            margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.08);
        }

        /* –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –±—é–¥–∂–µ—Ç–∞ */
        .budget-header { text-align: center; margin-bottom: 20px; }
        .big-money { font-size: 48px; font-weight: 800; letter-spacing: -2px; margin: 10px 0; }
        .sub-text { color: var(--text-sec); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
        .progress-bg { background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            border: none; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 600;
            width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.97); }
        .btn-green { background: var(--primary); color: #000; }
        .btn-red { background: rgba(255, 69, 58, 0.15); color: var(--danger); }
        .btn-outline { background: transparent; border: 1px solid var(--text-sec); color: var(--text-main); margin-top: 10px; }

        /* –°–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }

        /* –≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ô–ö–ò (Onboarding) */
        #setupScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 100; padding: 40px 20px; box-sizing: border-box;
            display: none; flex-direction: column; justify-content: center;
        }
        .input-lg {
            background: #1c1c1e; border: 2px solid #333; color: white;
            font-size: 24px; padding: 16px; border-radius: 12px; width: 100%;
            box-sizing: border-box; outline: none; text-align: center; margin: 20px 0;
        }
        .input-lg:focus { border-color: var(--primary); }

        /* –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π */
        #historyList { margin-top: 10px; }
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .del-btn { background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; opacity: 0.5; }

        /* –ì—Ä–∞—Ñ–∏–∫ */
        canvas { width: 100% !important; height: 200px !important; }
    </style>
</head>
<body>

    <div id="setupScreen">
        <h1 style="text-align: center;">–ù–∞—Å—Ç—Ä–æ–∏–º LifeOS</h1>
        <p style="text-align: center; color: var(--text-sec);">–í–≤–µ–¥–∏ —Å–≤–æ–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –±—é–¥–∂–µ—Ç –Ω–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü (–ø–æ—Å–ª–µ –≤—ã—á–µ—Ç–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã –∏ –∫—Ä–µ–¥–∏—Ç–æ–≤).</p>
        
        <input type="number" id="budgetInput" class="input-lg" placeholder="30000">
        
        <button class="btn btn-green" onclick="finishSetup()">üöÄ –ü–æ–µ—Ö–∞–ª–∏</button>
    </div>

    <div id="mainApp" style="display:none;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="greeting" style="margin:0;">–ü—Ä–∏–≤–µ—Ç</h2>
            <div style="font-size:12px; color:var(--text-sec);" id="todayDate">...</div>
        </div>

        <div class="card fade-in">
            <div class="budget-header">
                <div class="sub-text">–°–µ–≥–æ–¥–Ω—è –º–æ–∂–Ω–æ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å</div>
                <div class="big-money" id="dailyAmount">0 ‚ÇΩ</div>
                <div class="progress-bg"><div class="progress-fill" id="moneyBar"></div></div>
            </div>
            
            <div style="display:flex; justify-content:space-between; color:var(--text-sec); font-size:13px; margin-top:8px;">
                <span id="spentLabel">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: 0</span>
                <span id="leftLabel">–û—Å—Ç–∞–ª–æ—Å—å –Ω–∞ –º–µ—Å: 0</span>
            </div>

            <div class="grid-2">
                <button class="btn btn-green" onclick="markBudgetOK()">‚úÖ –í –Ω–æ—Ä–º–µ</button>
                <button class="btn btn-red" onclick="askExpense()">üí∏ –¢—Ä–∞—Ç–∞</button>
            </div>
        </div>

        <div class="card fade-in" style="animation-delay: 0.1s;">
            <div style="display:flex; justify-content:space-between; align-items:center; cursor: pointer;" onclick="toggleHistory()">
                <h3>üìú –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞—Ç (—Å–µ–≥–æ–¥–Ω—è)</h3>
                <span>‚ñº</span>
            </div>
            <div id="historyBlock" style="display:none;">
                <div id="historyList"></div>
                <button class="btn btn-outline" onclick="resetAll()">‚öôÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>
        </div>

        <div class="card fade-in" style="animation-delay: 0.2s;">
            <h3>üìä –î–∏–Ω–∞–º–∏–∫–∞ –ª–∏–º–∏—Ç–∞</h3>
            <canvas id="budgetChart"></canvas>
        </div>

    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    // --- 1. STATE MANAGEMENT ---
    let state = {
        isSetup: false,
        monthlyLimit: 0,     // –õ–∏–º–∏—Ç –Ω–∞ –º–µ—Å—è—Ü
        balance: 0,          // –¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫
        history: [],         // –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π {id, amount, date, type}
        chartData: [0,0,0,0,0] // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–ö–ª—é—á V3 - —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ)
    const loadData = () => {
        const str = localStorage.getItem('lifeos_v3');
        if(str) state = JSON.parse(str);
    };
    const saveData = () => localStorage.setItem('lifeos_v3', JSON.stringify(state));

    // --- 2. INIT LOGIC ---
    loadData();

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = tg.initDataUnsafe?.user;
    document.getElementById('greeting').innerText = user ? `–ü—Ä–∏–≤–µ—Ç, ${user.first_name}` : 'LifeOS';
    document.getElementById('todayDate').innerText = new Date().toLocaleDateString('ru-RU');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –ù–æ–≤—ã–π —é–∑–µ—Ä –∏–ª–∏ –Ω–µ—Ç?
    if (!state.isSetup) {
        document.getElementById('setupScreen').style.display = 'flex';
    } else {
        document.getElementById('mainApp').style.display = 'block';
        updateUI();
        initChart();
    }

    // --- 3. CORE FUNCTIONS ---

    function finishSetup() {
        const val = parseInt(document.getElementById('budgetInput').value);
        if (!val || val < 0) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');

        state.monthlyLimit = val;
        state.balance = val; // –ù–∞ —Å—Ç–∞—Ä—Ç–µ –±–∞–ª–∞–Ω—Å —Ä–∞–≤–µ–Ω –ª–∏–º–∏—Ç—É
        state.isSetup = true;
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ä—Ç–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        state.chartData = [val, val, val, val, val];
        
        saveData();
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω
        document.getElementById('setupScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        updateUI();
        initChart();
    }

    // –†–∞—Å—á–µ—Ç –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞
    function getDailyLimit() {
        const today = new Date();
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        const daysLeft = lastDay - today.getDate() + 1;
        return Math.floor(state.balance / daysLeft);
    }

    function updateUI() {
        const daily = getDailyLimit();
        document.getElementById('dailyAmount').innerText = `${daily.toLocaleString()} ‚ÇΩ`;
        document.getElementById('leftLabel').innerText = `–û—Å—Ç–∞—Ç–æ–∫: ${state.balance.toLocaleString()} ‚ÇΩ`;
        
        // –†–∞—Å—á–µ—Ç —Ç—Ä–∞—Ç –∑–∞ —Å–µ–≥–æ–¥–Ω—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const todayStr = new Date().toDateString();
        const spentToday = state.history
            .filter(x => x.date === todayStr)
            .reduce((acc, curr) => acc + curr.amount, 0);
            
        document.getElementById('spentLabel').innerText = `–¢—Ä–∞—Ç—ã —Å–µ–≥–æ–¥–Ω—è: ${spentToday} ‚ÇΩ`;

        // –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä (–≤–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –¥–µ–Ω—å)
        // –ï—Å–ª–∏ –ø–æ—Ç—Ä–∞—Ç–∏–ª –º–µ–Ω—å—à–µ –ª–∏–º–∏—Ç–∞ - –∑–µ–ª–µ–Ω—ã–π, –±–æ–ª—å—à–µ - –∫—Ä–∞—Å–Ω—ã–π
        const bar = document.getElementById('moneyBar');
        bar.style.width = '100%';
        bar.style.backgroundColor = daily > 0 ? '#32d74b' : '#ff453a';

        renderHistory();
    }

    function askExpense() {
        tg.showPopup({
            title: '–ù–æ–≤–∞—è —Ç—Ä–∞—Ç–∞',
            message: '–í–≤–µ–¥–∏ —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–∞:',
            buttons: [{id: 'ok', type: 'ok'}]
        }, () => {
            // –í –≤–µ–±–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º prompt, –≤ –Ω–∞—Ç–∏–≤–µ –ª—É—á—à–µ —Å–≤–æ–∏ –∫–Ω–æ–ø–∫–∏
            const amount = prompt("–°—É–º–º–∞ (‚ÇΩ):");
            if (amount && !isNaN(amount)) {
                addTransaction(parseInt(amount));
            }
        });
    }

    function addTransaction(amount) {
        state.balance -= amount;
        state.history.unshift({
            id: Date.now(),
            amount: amount,
            date: new Date().toDateString()
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ (—Å–¥–≤–∏–≥–∞–µ–º –¥–∞–Ω–Ω—ã–µ)
        state.chartData.shift();
        state.chartData.push(getDailyLimit()); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –¥–Ω–µ–≤–Ω–æ–π –ø—Ä–æ–≥–Ω–æ–∑

        saveData();
        updateUI();
        updateChart();
    }

    // –£–î–ê–õ–ï–ù–ò–ï (UNDO)
    function deleteTransaction(id) {
        if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –∏ –≤–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏?')) return;
        
        const index = state.history.findIndex(x => x.id === id);
        if (index > -1) {
            state.balance += state.history[index].amount; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ–Ω—å–≥–∏
            state.history.splice(index, 1);
            saveData();
            updateUI();
            updateChart();
        }
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        
        // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –æ–ø–µ—Ä–∞—Ü–∏–π
        state.history.slice(0, 5).forEach(item => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <span>üí∏ -${item.amount} ‚ÇΩ</span>
                <button class="del-btn" onclick="deleteTransaction(${item.id})">‚úñ</button>
            `;
            list.appendChild(div);
        });
    }

    function markBudgetOK() {
        tg.showPopup({ title: '–°—É–ø–µ—Ä!', message: '–î–µ—Ä–∂–∏—à—å —Ç–µ–º–ø. –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!' });
        tg.HapticFeedback.notificationOccurred('success');
    }

    function toggleHistory() {
        const block = document.getElementById('historyBlock');
        block.style.display = block.style.display === 'none' ? 'block' : 'none';
    }

    function resetAll() {
        if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ?')) {
            localStorage.removeItem('lifeos_v3');
            location.reload();
        }
    }

    // --- 4. CHART ---
    let myChart;

    function initChart() {
        const ctx = document.getElementById('budgetChart').getContext('2d');
        
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Start', '..', '..', '..', 'Now'],
                datasets: [{
                    label: '–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç',
                    data: state.chartData,
                    borderColor: '#32d74b',
                    backgroundColor: 'rgba(50, 215, 75, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { 
                        display: false,
                        grid: { display: false } 
                    }
                }
            }
        });
    }

    function updateChart() {
        if(myChart) {
            myChart.data.datasets[0].data = state.chartData;
            myChart.update();
        }
    }

</script>
</body>
</html>
