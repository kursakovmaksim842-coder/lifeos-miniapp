<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeOS v11.1 Pure Vision</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #020617;
            --card: rgba(15, 23, 42, 0.7);
            --primary: #3b82f6;
            --lava-hot: #ff4500;
            --lava-deep: #800000;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text-main); font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding: 0; overflow-x: hidden; }

        /* --- SETUP --- */
        #setupOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: none; flex-direction: column; justify-content: center; padding: 35px; backdrop-filter: blur(20px); }
        .input-gold { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: white; padding: 20px; border-radius: 20px; width: 100%; margin: 10px 0; font-size: 18px; text-align: center; font-weight: 700; }

        /* --- LAYOUT --- */
        .container { padding: 20px; padding-bottom: 110px; display: none; width: 100%; max-width: 500px; margin: 0 auto; }
        .container.active { display: block; animation: appleShow 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes appleShow { from { opacity: 0; transform: scale(0.98) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .glass-card { background: var(--card); border: 1px solid var(--border); border-radius: 28px; padding: 20px; margin-bottom: 15px; position: relative; }
        .title-sm { font-size: 10px; font-weight: 800; color: var(--text-sec); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 6px; }

        /* --- PREMIUIM LAVA (EXCLUSIVE TO FINANCE) --- */
        .lava-box { 
            position: relative; width: 60px; height: 90px; background: #070a13; 
            border-radius: 20px; overflow: hidden; border: 2px solid rgba(255, 69, 0, 0.2); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 15px #000; 
        }
        .lava-wave-wrapper { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; 
            background: linear-gradient(180deg, var(--lava-hot), var(--lava-deep)); 
            transition: height 2.5s cubic-bezier(0.23, 1, 0.32, 1); 
            box-shadow: 0 -5px 20px rgba(255, 69, 0, 0.6);
        }
        .wave { 
            position: absolute; top: -12px; left: 0; width: 200%; height: 25px; 
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5,73.84-4.36,147.54,16.88,218.2,52.56,54.05,27.26,114.91,48.29,174.6,47.81,96.24-.77,193.3-35.26,289.1-77.57,50.32-22.21,101.45-38.34,153.3-47.51V0Z" fill="%23ff4500" opacity="0.8"></path></svg>');
            background-size: 50% 100%; animation: lavaWaveMove 3s infinite linear;
        }
        @keyframes lavaWaveMove { from { transform: translateX(0); } to { transform: translateX(-50%); } }

        /* --- TRANSACTIONS --- */
        .tx-card { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .tx-card.deleting { opacity: 0; transform: scale(0.9) translateX(-50px); filter: blur(10px); }

        /* --- HABITS --- */
        .bubble-row { display: flex; justify-content: space-between; margin-top: 15px; }
        .day-bubble { width: 32px; height: 32px; border-radius: 10px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; background: var(--glass); color: var(--text-sec); }
        .day-bubble.active { background: var(--primary); border-color: var(--primary); color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .day-bubble.past { opacity: 0.3; pointer-events: none; }

        /* --- NAVIGATION --- */
        .tab-bar { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 92%; height: 70px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(25px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; border: 1px solid var(--border); z-index: 1000; }
        .tab-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sec); font-size: 10px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .tab-item.active { color: var(--primary); }
    </style>
</head>
<body>

    <div id="setupOverlay">
        <div style="background: var(--card); border: 1px solid var(--border); padding: 30px; border-radius: 35px; text-align: center;">
            <h2 style="letter-spacing: -1px;">LifeOS Setup</h2>
            <input type="number" id="initBalance" class="input-gold" placeholder="–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (‚ÇΩ)">
            <input type="number" id="initFixed" class="input-gold" placeholder="–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–∞—Ç—ã (‚ÇΩ)">
            <button onclick="completeSetup()" class="input-gold" style="background:var(--primary); border:none; margin-top:15px; color:white;">–ù–∞—á–∞—Ç—å –ø—É—Ç—å</button>
        </div>
    </div>

    <div id="tab-fin" class="container active">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-top: 20px; margin-bottom: 30px;">
            <div>
                <div class="title-sm">–î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                <div id="dailyVal" style="font-size: 46px; font-weight: 800; letter-spacing: -2px;">0 ‚ÇΩ</div>
            </div>
            
            <div class="lava-box">
                <div class="lava-wave-wrapper" id="lavaFill">
                    <div class="wave"></div>
                </div>
                <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:12px; text-shadow: 0 2px 10px rgba(0,0,0,0.8); color:white;">
                    <span id="streakNum">1</span>
                </div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:20px;">
            <div class="glass-card" style="margin:0;"><div class="title-sm" style="color:var(--lava-hot)">–°–µ–π—Ñ (20%)</div><div id="saveVal" style="font-weight:800; font-size:20px;">0 ‚ÇΩ</div></div>
            <div class="glass-card" style="margin:0;"><div class="title-sm" style="color:var(--primary)">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ</div><div id="fixVal" style="font-weight:800; font-size:20px;">0 / 0 ‚ÇΩ</div></div>
        </div>

        <button onclick="addFixedTask()" class="input-gold" style="font-size:13px; background:var(--glass); margin-bottom:20px; height:55px;">+ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Ç—Ä–∞—Ç–∞</button>
        <div id="fixedTasksList"></div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <button onclick="incomeUI()" class="input-gold" style="background:var(--primary); border:none; margin:0; font-size:14px; color:white;">+ –î–æ—Ö–æ–¥</button>
            <button onclick="expenseUI()" class="input-gold" style="background:var(--card); margin:0; font-size:14px;">- –¢—Ä–∞—Ç–∞</button>
        </div>

        <h3 class="title-sm" style="margin-top:30px;">–ò—Å—Ç–æ—Ä–∏—è (–Ω–∞–∂–º–∏ üóë)</h3>
        <div id="txList"></div>
    </div>

    <div id="tab-hab" class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <h1 style="margin:0; letter-spacing:-1.5px;">–ó–∞–¥–∞—á–∏</h1>
            <button onclick="addNewHabit()" style="background:var(--primary); color:white; border:none; width:45px; height:45px; border-radius:18px; font-weight:800; font-size:20px;">+</button>
        </div>
        <div id="habitList"></div>
        <div class="glass-card" style="margin-top:20px;"><div class="title-sm">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–ª–µ–π</div><canvas id="habChart" height="150"></canvas></div>
    </div>

    <div id="tab-ins" class="container">
        <h1 style="margin-bottom:25px; letter-spacing:-1.5px;">–ò—Ç–æ–≥–∏</h1>
        <div class="glass-card" style="text-align:center; padding:35px 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), transparent);">
            <div class="title-sm">–¢–≤–æ–π –†–∞–Ω–≥</div>
            <div id="rankTitle" style="font-size:34px; font-weight:900; color:var(--primary); margin:10px 0; letter-spacing:-1px;">–ù–û–í–ò–ß–û–ö</div>
            <div style="font-size:12px; color:var(--text-sec);">–°—Ç–∞–Ω—å –ª–µ–≥–µ–Ω–¥–æ–π, –≤–µ–¥—è —É—á–µ—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.</div>
        </div>
        <div class="glass-card"><div class="title-sm">–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞</div><canvas id="radarChart"></canvas></div>
        <div class="glass-card"><div class="title-sm">–ö–∞–ø–∏—Ç–∞–ª</div><canvas id="capitalChart" height="200"></canvas></div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('fin', this)"><span>üèõ</span><span>–ë–∞–Ω–∫</span></div>
        <div class="tab-item" onclick="switchTab('hab', this)"><span>‚ö°</span><span>–ó–∞–¥–∞—á–∏</span></div>
        <div class="tab-item" onclick="switchTab('ins', this)"><span>üìä</span><span>–ò—Ç–æ–≥–∏</span></div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let db = {
        setup: false, balance: 0, fixedTarget: 0, fixedCurrent: 0,
        savings: 0, txs: [], fixedTasks: [], habits: [], streak: 1, lastLog: new Date().toDateString()
    };

    const load = () => {
        const s = localStorage.getItem('lifeos_v11.1');
        if(s) db = JSON.parse(s);
        if(!db.setup) document.getElementById('setupOverlay').style.display = 'flex';
        render();
    };
    const save = () => { localStorage.setItem('lifeos_v11.1', JSON.stringify(db)); render(); };

    function completeSetup() {
        db.balance = +document.getElementById('initBalance').value;
        db.fixedTarget = +document.getElementById('initFixed').value;
        db.setup = true;
        save();
        document.getElementById('setupOverlay').style.display = 'none';
    }

    function smartDistribute(val) {
        let toSave = Math.floor(val * 0.2); db.savings += toSave;
        let rem = val - toSave;
        let needed = db.fixedTarget - db.fixedCurrent;
        if(needed > 0) { let toFix = Math.min(rem, needed); db.fixedCurrent += toFix; rem -= toFix; }
        db.balance += rem;
    }

    function incomeUI() { const v = +prompt("–î–æ—Ö–æ–¥:"); if(v) { smartDistribute(v); updateStreak(); save(); } }
    function expenseUI() { const v = +prompt("–¢—Ä–∞—Ç–∞:"); if(v) { db.balance -= v; db.txs.unshift({id:Date.now(), val:v, cat:prompt("–ù–∞ —á—Ç–æ?"), t:new Date().toLocaleTimeString().slice(0,5)}); updateStreak(); save(); } }

    function addFixedTask() {
        const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:");
        const a = +prompt("–°—É–º–º–∞:");
        if(n && a) { db.fixedTasks.push({id:Date.now(), name:n, amount:a}); save(); }
    }

    function payFixed(id, amount) {
        if(db.fixedCurrent >= amount) {
            db.fixedCurrent -= amount;
            db.fixedTasks = db.fixedTasks.filter(t => t.id !== id);
            tg.HapticFeedback.notificationOccurred('success');
            save();
        } else alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤ —Ä–µ–∑–µ—Ä–≤–µ!");
    }

    function deleteTx(id) {
        const el = document.getElementById('tx-' + id);
        el.classList.add('deleting');
        setTimeout(() => {
            const tx = db.txs.find(x => x.id === id);
            db.balance += tx.val;
            db.txs = db.txs.filter(x => x.id !== id);
            save();
        }, 400);
    }

    function updateStreak() {
        const today = new Date().toDateString();
        if(db.lastLog === today) return;
        const yest = new Date(Date.now()-86400000).toDateString();
        db.streak = (db.lastLog === yest) ? db.streak + 1 : 1;
        db.lastLog = today;
    }

    function render() {
        const dRem = new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate() - new Date().getDate() + 1;
        document.getElementById('dailyVal').innerText = Math.max(0, Math.floor(db.balance / dRem)).toLocaleString() + ' ‚ÇΩ';
        document.getElementById('saveVal').innerText = db.savings.toLocaleString() + ' ‚ÇΩ';
        document.getElementById('fixVal').innerText = `${db.fixedCurrent.toLocaleString()} / ${db.fixedTarget.toLocaleString()} ‚ÇΩ`;
        
        // Lava Update
        const lavaPct = Math.min(100, (db.streak / 30) * 100);
        document.getElementById('lavaFill').style.height = lavaPct + '%';
        document.getElementById('streakNum').innerText = db.streak;

        document.getElementById('fixedTasksList').innerHTML = db.fixedTasks.map(t => `
            <div class="glass-card" style="display:flex; justify-content:space-between; align-items:center; border-left:4px solid var(--primary);">
                <div><div style="font-weight:800;">${t.name}</div><div style="font-size:10px; color:var(--text-sec);">${t.amount} ‚ÇΩ</div></div>
                <button onclick="payFixed(${t.id}, ${t.amount})" style="background:var(--primary); border:none; color:white; padding:8px 12px; border-radius:10px; font-weight:700; font-size:11px;">–û–ø–ª–∞—Ç–∏—Ç—å</button>
            </div>
        `).join('');

        document.getElementById('txList').innerHTML = db.txs.slice(0, 5).map(t => `
            <div class="glass-card tx-card" id="tx-${t.id}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div><div style="font-weight:800;">${t.cat}</div><div style="font-size:10px; color:var(--text-sec);">${t.t}</div></div>
                    <div style="display:flex; align-items:center; gap:15px;">
                        <span style="color:var(--lava-hot); font-weight:800;">-${t.val} ‚ÇΩ</span>
                        <span onclick="deleteTx(${t.id})" style="font-size:18px;">üóë</span>
                    </div>
                </div>
            </div>
        `).join('');

        renderHabits();
        updateRank();
    }

    function renderHabits() {
        const curDay = (new Date().getDay() + 6) % 7;
        document.getElementById('habitList').innerHTML = db.habits.map(h => {
            const bubbles = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].map((d, i) => {
                const dateKey = getWeekDate(i);
                const active = h.done.includes(dateKey) ? 'active' : '';
                const cls = (i < curDay) ? 'past' : (i > curDay ? 'future' : '');
                return `<div class="day-bubble ${active} ${cls}" onclick="${i <= curDay ? `toggleHab(${h.id}, '${dateKey}')` : ''}">${d}</div>`;
            }).join('');
            return `<div class="glass-card"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span style="font-weight:800;">${h.name}</span><span style="color:var(--primary); font-weight:800; font-size:12px;">${h.done.length} / ${h.goal}</span></div><div class="bubble-row">${bubbles}</div></div>`;
        }).join('');
    }

    function toggleHab(id, date) {
        const h = db.habits.find(x => x.id === id);
        if(h.done.includes(date)) h.done = h.done.filter(d => d !== date);
        else h.done.push(date);
        save(); initCharts();
    }

    function getWeekDate(i) {
        const d = new Date(); const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1) + i;
        return new Date(d.setDate(diff)).toDateString();
    }

    function addNewHabit() {
        const n = prompt("–¶–µ–ª—å:");
        const g = +prompt("–†–∞–∑ –≤ –º–µ—Å—è—Ü:");
        if(n && g) { db.habits.push({id:Date.now(), name:n, goal:g, done:[]}); save(); }
    }

    function switchTab(id, el) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        if(id !== 'fin') setTimeout(initCharts, 100);
    }

    function updateRank() {
        const score = (db.streak * 10) + (db.habits.reduce((a,b)=>a+b.done.length, 0) * 5);
        let title = "–ù–û–í–ò–ß–û–ö";
        if(score > 50) title = "–ê–†–•–ò–¢–ï–ö–¢–û–†";
        if(score > 150) title = "–ú–ê–°–¢–ï–†";
        if(score > 300) title = "–õ–ï–ì–ï–ù–î–ê";
        document.getElementById('rankTitle').innerText = title;
    }

    function initCharts() {
        const ctxH = document.getElementById('habChart')?.getContext('2d');
        if(ctxH) {
            if(window.c1) window.c1.destroy();
            window.c1 = new Chart(ctxH, {
                type: 'bar',
                data: { labels: db.habits.map(h => h.name.slice(0,6)), datasets: [{ data: db.habits.map(h => h.done.length), backgroundColor: '#3b82f6', borderRadius: 8 }] },
                options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } } }
            });
        }
        const ctxR = document.getElementById('radarChart')?.getContext('2d');
        if(ctxR) {
            if(window.c2) window.c2.destroy();
            window.c2 = new Chart(ctxR, {
                type: 'radar',
                data: {
                    labels: ['–ë—é–¥–∂–µ—Ç', '–ó–∞–¥–∞—á–∏', '–°—Ç—Ä–∏–∫', '–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è'],
                    datasets: [{ data: [90, 70, (db.streak/30)*100, 100], backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0 }]
                },
                options: { scales: { r: { display: true, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.05)' } } }, plugins: { legend: { display: false } } }
            });
        }
        const ctxK = document.getElementById('capitalChart')?.getContext('2d');
        if(ctxK) {
            if(window.c3) window.c3.destroy();
            window.c3 = new Chart(ctxK, {
                type: 'doughnut',
                data: { labels: ['–ë–∞–ª–∞–Ω—Å', '–°—á–µ—Ç–∞', '–°–µ–π—Ñ'], datasets: [{ data: [db.balance, db.fixedCurrent, db.savings], backgroundColor: ['#3b82f6', '#1e293b', '#ff4500'], borderWidth: 0 }] },
                options: { cutout: '80%', plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', font: { size: 10 } } } } }
            });
        }
    }

    load();
</script>
</body>
</html>

