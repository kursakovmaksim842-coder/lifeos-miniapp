<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeOS v15 Hyper Vision</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #000000;
            --glass: rgba(30, 30, 35, 0.7);
            --glass-highlight: rgba(255, 255, 255, 0.08);
            --primary: #0A84FF; /* iOS Blue */
            --accent: #BF5AF2; /* iOS Purple */
            --success: #32D74B; /* iOS Green */
            --danger: #FF453A; /* iOS Red */
            --text-main: #FFFFFF;
            --text-sec: #8E8E93;
            --radius: 24px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            background: var(--bg); 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-main); margin: 0; padding: 0; 
            overflow-x: hidden; min-height: 100vh;
            /* –ñ–∏–≤–æ–π —Ñ–æ–Ω */
            background: radial-gradient(circle at 50% -20%, #1c1c2e 0%, #000000 70%);
        }

        /* --- –ö–û–ú–ü–û–ù–ï–ù–¢–´ –î–ò–ó–ê–ô–ù–ê --- */
        .h-title { font-weight: 900; font-size: 34px; letter-spacing: -1px; margin: 0 0 10px 0; }
        .h-subtitle { font-size: 13px; color: var(--text-sec); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        
        /* Glass Card - –°—É–ø–µ—Ä –ø—Ä–µ–º–∏—É–º —ç—Ñ—Ñ–µ–∫—Ç */
        .card {
            background: var(--glass);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--glass-highlight);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
        }
        
        /* –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.03), transparent 60%);
            pointer-events: none;
        }

        .btn-main {
            background: var(--text-main); color: #000; border: none;
            width: 100%; padding: 18px; border-radius: 20px;
            font-size: 17px; font-weight: 700; letter-spacing: -0.5px;
            transition: transform 0.1s; cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 255, 255, 0.2);
        }
        .btn-main:active { transform: scale(0.96); }
        
        .btn-sec {
            background: rgba(255,255,255,0.1); color: #fff; border: none;
            width: 100%; padding: 18px; border-radius: 20px;
            font-size: 17px; font-weight: 600;
            transition: transform 0.1s; cursor: pointer;
        }
        .btn-sec:active { transform: scale(0.96); background: rgba(255,255,255,0.15); }

        /* –ö–Ω–æ–ø–∫–∞ "–í–æ–ø—Ä–æ—Å" */
        .info-btn {
            width: 18px; height: 18px; border-radius: 50%;
            background: rgba(255,255,255,0.15); color: var(--text-sec);
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 700; cursor: pointer;
        }

        /* --- –ì–õ–ê–í–ù–´–ô –ë–Æ–î–ñ–ï–¢ --- */
        .big-number {
            font-size: 52px; font-weight: 800; letter-spacing: -2px;
            background: linear-gradient(180deg, #FFF 0%, #A1A1AA 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        
        /* –°—Ñ–µ—Ä–∞ –°—Ç—Ä–∏–∫–∞ (Holo-Core) */
        .holo-core {
            width: 60px; height: 60px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff, #8b5cf6, #000);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.6);
            position: absolute; top: 24px; right: 24px;
            animation: float 6s ease-in-out infinite;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 20px; color: white;
            z-index: 10; cursor: pointer;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* --- TABS --- */
        .tab-content { display: none; padding: 20px 20px 120px 20px; max-width: 480px; margin: 0 auto; }
        .tab-content.active { display: block; animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .dock {
            position: fixed; bottom: 30px; left: 20px; right: 20px; height: 75px;
            background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(50px);
            border-radius: 28px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 999; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .dock-item { text-align: center; opacity: 0.5; transition: 0.3s; transform: scale(0.9); }
        .dock-item.active { opacity: 1; transform: scale(1); }
        .dock-icon { font-size: 24px; display: block; margin-bottom: 2px; }
        .dock-label { font-size: 10px; font-weight: 600; letter-spacing: 0.5px; }

        /* –ú–æ–¥–∞–ª–∫–∞ —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π */
        #infoModal {
            position: fixed; inset: 0; z-index: 6000;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            display: none; align-items: flex-end; justify-content: center;
        }
        .sheet {
            background: #1c1c1e; width: 100%; border-radius: 30px 30px 0 0;
            padding: 30px; animation: slideUp 0.3s ease;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Input Styles */
        .clean-input {
            background: rgba(255,255,255,0.05); border: none;
            color: white; padding: 16px; border-radius: 16px;
            font-size: 18px; width: 100%; text-align: center;
            margin-bottom: 10px; font-weight: 600;
        }

    </style>
</head>
<body>

    <div id="setupOverlay" style="position:fixed; inset:0; z-index:5000; background:#000; display:none; flex-direction:column; justify-content:center; padding:30px;">
        <h1 class="h-title" style="text-align:center">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
        <p style="text-align:center; color:var(--text-sec); margin-bottom:40px; font-size:15px; line-height:1.5;">
            LifeOS –ø–æ–º–æ–∂–µ—Ç –Ω–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ –¥–µ–Ω—å–≥–∞—Ö. <br>–î–∞–≤–∞–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏–º –±–∞–∑–æ–≤—ã–µ —Ü–∏—Ñ—Ä—ã.
        </p>
        
        <div style="margin-bottom:20px;">
            <label class="h-subtitle">–°–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ —É –≤–∞—Å —Å–µ–π—á–∞—Å?</label>
            <input type="number" id="initBalance" class="clean-input" placeholder="0 ‚ÇΩ">
        </div>
        
        <div style="margin-bottom:20px;">
            <label class="h-subtitle">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–∞—Ç—ã –≤ –º–µ—Å—è—Ü</label>
            <div style="font-size:11px; color:var(--text-sec); margin-bottom:5px;">(–ê—Ä–µ–Ω–¥–∞, –∫—Ä–µ–¥–∏—Ç—ã, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)</div>
            <input type="number" id="initFixed" class="clean-input" placeholder="0 ‚ÇΩ">
        </div>
        
        <div style="margin-bottom:30px;">
            <label class="h-subtitle">–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞—Ä–ø–ª–∞—Ç—ã</label>
            <input type="date" id="initDate" class="clean-input" style="color-scheme:dark;">
        </div>
        
        <button onclick="completeSetup()" class="btn-main">–ù–∞—á–∞—Ç—å</button>
    </div>

    <div id="tab-fin" class="tab-content active">
        
        <div style="position:relative; margin-bottom: 30px;">
            <div class="h-subtitle">
                –î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                <div class="info-btn" onclick="showInfo('daily')">?</div>
            </div>
            <div id="dailyVal" class="big-number">0 ‚ÇΩ</div>
            <div style="font-size:13px; color:var(--primary); font-weight:600; display:flex; align-items:center; gap:5px; margin-top:5px;">
                <span id="salaryDateText">–î–æ –∑–∞—Ä–ø–ª–∞—Ç—ã ...</span>
                <span onclick="changeSalaryDate()" style="background:rgba(10, 132, 255, 0.15); padding:2px 8px; border-radius:6px; cursor:pointer;">–ò–∑–º–µ–Ω–∏—Ç—å</span>
            </div>

            <div class="holo-core" onclick="showInfo('streak')">
                <span id="streakNum">1</span>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:20px;">
            <div class="card" style="margin:0; padding:18px;">
                <div class="h-subtitle" style="color:#FFD60A">–°–µ–π—Ñ (20%) <div class="info-btn" onclick="showInfo('safe')">?</div></div>
                <div id="saveVal" style="font-size:18px; font-weight:700;">0 ‚ÇΩ</div>
            </div>
            <div class="card" style="margin:0; padding:18px;">
                <div class="h-subtitle">–ü–ª–∞—Ç–µ–∂–∏ <div class="info-btn" onclick="showInfo('fixed')">?</div></div>
                <div id="fixVal" style="font-size:16px; font-weight:700;">0 / 0</div>
            </div>
        </div>

        <div style="display:flex; gap:12px; margin-bottom:30px;">
            <button onclick="incomeUI()" class="btn-sec" style="background:rgba(50, 215, 75, 0.15); color:var(--success);">+ –î–æ—Ö–æ–¥</button>
            <button onclick="expenseUI()" class="btn-main">- –¢—Ä–∞—Ç–∞</button>
        </div>

        <div class="h-subtitle">–ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="card" style="padding:10px 20px;" id="txList">
            </div>
    </div>

    <div id="tab-hab" class="tab-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div class="h-title">–ü—Ä–∏–≤—ã—á–∫–∏</div>
            <button onclick="addNewHabit()" style="width:40px; height:40px; border-radius:12px; border:none; background:var(--text-main); font-size:24px;">+</button>
        </div>
        <div id="habitList"></div>
        <div class="card">
            <div class="h-subtitle">–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
            <canvas id="habChart" height="200"></canvas>
        </div>
    </div>

    <div id="tab-ins" class="tab-content">
        <div class="h-title">–ò—Ç–æ–≥–∏</div>
        <div class="card" style="text-align:center;">
            <div class="h-subtitle" style="justify-content:center;">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</div>
            <div id="rankTitle" style="font-size:36px; font-weight:900; margin:10px 0; color:var(--accent);">–ù–û–í–ò–ß–û–ö</div>
            <p style="font-size:13px; color:var(--text-sec); line-height:1.4;">
                –í–∞—à —Å—Ç–∞—Ç—É—Å —Ä–∞—Å—Ç–µ—Ç, –∫–æ–≥–¥–∞ –≤—ã –≤–µ–¥–µ—Ç–µ —É—á–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç–µ –ø—Ä–∏–≤—ã—á–∫–∏ –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤.
            </p>
        </div>
        <div class="card">
            <div class="h-subtitle">–ö–æ–ª–µ—Å–æ –±–∞–ª–∞–Ω—Å–∞</div>
            <canvas id="radarChart"></canvas>
        </div>
        <button onclick="hardReset()" class="btn-sec" style="color:var(--danger);">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
    </div>

    <div id="infoModal" onclick="this.style.display='none'">
        <div class="sheet" onclick="event.stopPropagation()">
            <h2 id="infoTitle" style="margin-top:0;">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h2>
            <p id="infoText" style="color:var(--text-sec); line-height:1.6; font-size:15px;"></p>
            <button onclick="document.getElementById('infoModal').style.display='none'" class="btn-main" style="margin-top:20px;">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
    </div>

    <div class="dock">
        <div class="dock-item active" onclick="switchTab('fin', this)">
            <span class="dock-icon">‚ùñ</span><span class="dock-label">–ì–ª–∞–≤–Ω–∞—è</span>
        </div>
        <div class="dock-item" onclick="switchTab('hab', this)">
            <span class="dock-icon">‚ö°</span><span class="dock-label">–¢—Ä–µ–∫–µ—Ä</span>
        </div>
        <div class="dock-item" onclick="switchTab('ins', this)">
            <span class="dock-icon">‚öõ</span><span class="dock-label">–ò–Ω—Ñ–æ</span>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // --- DATA STORE ---
    let db = {
        setup: false, 
        balance: 0, 
        fixedTarget: 0, 
        fixedCurrent: 0,
        savings: 0, 
        txs: [], 
        habits: [], 
        streak: 1, 
        lastLog: new Date().toDateString(), 
        salaryDate: null
    };

    // --- EXPLANATIONS DATABASE ---
    const helpData = {
        daily: { t: "–î–Ω–µ–≤–Ω–æ–π –±—é–¥–∂–µ—Ç", d: "–≠—Ç–æ —Å—É–º–º–∞, –∫–æ—Ç–æ—Ä—É—é –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è –±–µ–∑–æ–ø–∞—Å–Ω–æ. –û–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–∞–∫: (–í–∞—à–∏ –¥–µ–Ω—å–≥–∏ - –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏) / –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ –∑–∞—Ä–ø–ª–∞—Ç—ã." },
        safe: { t: "–°–µ–π—Ñ (20%)", d: "–°—é–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ª–µ—Ç–∞–µ—Ç 20% –æ—Ç –ª—é–±–æ–≥–æ –≤–∞—à–µ–≥–æ –¥–æ—Ö–æ–¥–∞. –≠—Ç–æ –≤–∞—à–∞ –ø–æ–¥—É—à–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –¢—Ä–∞—Ç–∏—Ç—å –æ—Ç—Å—é–¥–∞ –Ω–µ–ª—å–∑—è!" },
        fixed: { t: "–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏", d: "–î–µ–Ω—å–≥–∏ –Ω–∞ –∞—Ä–µ–Ω–¥—É, –∫—Ä–µ–¥–∏—Ç—ã –∏ –ø–æ–¥–ø–∏—Å–∫–∏. –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–æ—Ö–æ–¥–∞ —Å–∏—Å—Ç–µ–º–∞ –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç —ç—Ç—É –∫–æ–ø–∏–ª–∫—É." },
        streak: { t: "–°—Ç—Ä–∏–∫ (–°–µ—Ä–∏—è)", d: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥, –∫–æ–≥–¥–∞ –≤—ã –∑–∞—Ö–æ–¥–∏–ª–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–π—Ç–µ —Å–µ—Ä–∏—é, —á—Ç–æ–±—ã –ø–æ–≤—ã—Å–∏—Ç—å —Å–≤–æ–π —Ä–∞–Ω–≥!" }
    };

    // --- INIT ---
    function load() {
        const s = localStorage.getItem('lifeos_v15');
        if(s) db = JSON.parse(s);
        
        if(!db.setup) {
            document.getElementById('setupOverlay').style.display = 'flex';
            document.getElementById('initDate').valueAsDate = new Date();
        } else {
            checkStreak();
        }
        render();
    }

    function save() {
        localStorage.setItem('lifeos_v15', JSON.stringify(db));
        render();
    }

    // --- LOGIC ---
    function completeSetup() {
        const bal = document.getElementById('initBalance').value;
        const fix = document.getElementById('initFixed').value;
        const date = document.getElementById('initDate').value;
        
        if(!bal || !fix || !date) return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.");
        
        db.balance = +bal;
        db.fixedTarget = +fix;
        db.salaryDate = date;
        db.setup = true;
        
        save();
        document.getElementById('setupOverlay').style.display = 'none';
    }

    function checkStreak() {
        const today = new Date().toDateString();
        if (db.lastLog !== today) {
            const yest = new Date(Date.now() - 86400000).toDateString();
            if (db.lastLog === yest) db.streak++;
            else db.streak = 1;
            db.lastLog = today;
            save(); // Save quietly
        }
    }

    function showInfo(key) {
        document.getElementById('infoTitle').innerText = helpData[key].t;
        document.getElementById('infoText').innerText = helpData[key].d;
        document.getElementById('infoModal').style.display = 'flex';
        tg.HapticFeedback.impactOccurred('light');
    }

    // --- MONEY LOGIC (FIXED) ---
    function incomeUI() {
        const val = +prompt("–°—É–º–º–∞ –¥–æ—Ö–æ–¥–∞ (‚ÇΩ):");
        if (!val) return;

        // 1. 20% –≤ —Å–µ–π—Ñ
        const toSave = Math.floor(val * 0.2);
        // 2. –û—Å—Ç–∞–ª—å–Ω–æ–µ –Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ, –µ—Å–ª–∏ —Ç–∞–º –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç
        const neededFixed = Math.max(0, db.fixedTarget - db.fixedCurrent);
        const remainderAfterSave = val - toSave;
        const toFixed = Math.min(remainderAfterSave, neededFixed);
        // 3. –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –∂–∏–∑–Ω—å
        const toBalance = remainderAfterSave - toFixed;

        db.savings += toSave;
        db.fixedCurrent += toFixed;
        db.balance += toBalance;

        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ—Ç–æ–º
        db.txs.unshift({
            id: Date.now(),
            val: val,
            type: 'inc',
            cat: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ',
            split: { s: toSave, f: toFixed, b: toBalance },
            date: new Date().toLocaleDateString()
        });
        save();
        alert(`üí∞ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ:\n–°–µ–π—Ñ: +${toSave}‚ÇΩ\n–ü–ª–∞—Ç–µ–∂–∏: +${toFixed}‚ÇΩ\n–ù–∞ –∂–∏–∑–Ω—å: +${toBalance}‚ÇΩ`);
    }

    function expenseUI() {
        const val = +prompt("–°–∫–æ–ª—å–∫–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏?");
        if (!val) return;
        
        const cat = prompt("–ù–∞ —á—Ç–æ? (–ï–¥–∞, –¢–∞–∫—Å–∏...)") || "–†–∞–∑–Ω–æ–µ";
        db.balance -= val;
        db.txs.unshift({
            id: Date.now(),
            val: val,
            type: 'exp',
            cat: cat,
            date: new Date().toLocaleDateString()
        });
        save();
    }

    function deleteTx(id) {
        if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) return;
        
        const idx = db.txs.findIndex(t => t.id === id);
        if (idx === -1) return;
        const tx = db.txs[idx];

        if (tx.type === 'inc') {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º (–≤—ã—á–∏—Ç–∞–µ–º) –¥–µ–Ω—å–≥–∏ –æ—Ç—Ç—É–¥–∞, –∫—É–¥–∞ –æ–Ω–∏ —É—à–ª–∏
            db.savings -= (tx.split?.s || 0);
            db.fixedCurrent -= (tx.split?.f || 0);
            db.balance -= (tx.split?.b || 0);
        } else {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ–Ω—å–≥–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å
            db.balance += tx.val;
        }

        db.txs.splice(idx, 1);
        save();
    }

    // --- RENDER ---
    function render() {
        // 1. –†–∞—Å—á–µ—Ç –¥–Ω–µ–π
        const now = new Date(); now.setHours(0,0,0,0);
        const target = new Date(db.salaryDate); target.setHours(0,0,0,0);
        let daysLeft = Math.ceil((target - now) / (1000 * 60 * 60 * 24));
        if (daysLeft < 1) daysLeft = 1;

        // 2. –†–∞—Å—á–µ—Ç –±—é–¥–∂–µ—Ç–∞
        // –î–æ—Å—Ç—É–ø–Ω–æ = (–ë–∞–ª–∞–Ω—Å–°–µ–π—á–∞—Å + –¢—Ä–∞—Ç—ã–°–µ–≥–æ–¥–Ω—è) / –î–Ω–µ–π
        const todayStr = new Date().toLocaleDateString();
        const spentToday = db.txs
            .filter(t => t.type === 'exp' && t.date === todayStr)
            .reduce((a,b) => a + b.val, 0);

        // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É—Ä–∞–∫–∞, –µ—Å–ª–∏ –±–∞–ª–∞–Ω—Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π
        const safeBalance = Math.max(0, db.balance); 
        // –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –Ω–∞ —É—Ç—Ä–æ
        const morningBalance = safeBalance + spentToday;
        
        const dailyLimit = Math.floor(morningBalance / daysLeft);
        const availableNow = dailyLimit - spentToday;

        // DOM Updates
        document.getElementById('dailyVal').innerText = Math.floor(availableNow).toLocaleString() + ' ‚ÇΩ';
        document.getElementById('salaryDateText').innerText = `–î–æ –∑–∞—Ä–ø–ª–∞—Ç—ã ${daysLeft} –¥–Ω.`;
        document.getElementById('saveVal').innerText = db.savings.toLocaleString() + ' ‚ÇΩ';
        document.getElementById('fixVal').innerText = `${db.fixedCurrent} / ${db.fixedTarget}`;
        document.getElementById('streakNum').innerText = db.streak;

        // History
        const list = document.getElementById('txList');
        if (db.txs.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:var(--text-sec); padding:10px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
        } else {
            list.innerHTML = db.txs.slice(0,10).map(t => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.05);">
                    <div>
                        <div style="font-weight:600; font-size:15px;">${t.cat}</div>
                        <div style="font-size:11px; color:var(--text-sec);">${t.date}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:700; color:${t.type==='inc'?'var(--success)':'#fff'};">
                            ${t.type==='inc'?'+':'-'}${t.val} ‚ÇΩ
                        </div>
                        <div onclick="deleteTx(${t.id})" style="font-size:10px; color:var(--danger); margin-top:4px; cursor:pointer;">—É–¥–∞–ª–∏—Ç—å</div>
                    </div>
                </div>
            `).join('');
        }

        renderHabits();
        updateRank();
    }

    function renderHabits() {
        const container = document.getElementById('habitList');
        container.innerHTML = db.habits.map(h => {
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
            const daysHTML = [0,1,2,3,4,5,6].map(i => {
                const d = new Date();
                const day = d.getDay(); 
                // –°–¥–≤–∏–≥, —á—Ç–æ–±—ã 0 —ç—Ç–æ –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏)
                const diff = d.getDate() - day + (day == 0 ? -6:1) + i; 
                const dateObj = new Date(d.setDate(diff));
                const dateKey = dateObj.toLocaleDateString();
                const isActive = h.done.includes(dateKey);
                
                return `<div onclick="toggleHab(${h.id}, '${dateKey}')" 
                        style="flex:1; height:6px; border-radius:3px; background:${isActive ? 'var(--primary)' : 'rgba(255,255,255,0.1)'}; transition:0.2s;"></div>`;
            }).join('');

            return `
            <div class="card" style="padding:15px; display:flex; flex-direction:column; gap:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:700; font-size:16px;">${h.name}</span>
                    <span style="font-size:12px; color:var(--text-sec);">${h.done.length}/${h.goal}</span>
                </div>
                <div style="display:flex; gap:5px; height:20px; align-items:center;">${daysHTML}</div>
            </div>`;
        }).join('');
    }

    // --- CHARTS & UTILS ---
    function initCharts() {
        // Radar
        const ctxR = document.getElementById('radarChart').getContext('2d');
        if (window.c1) window.c1.destroy();
        window.c1 = new Chart(ctxR, {
            type: 'radar',
            data: {
                labels: ['–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞', '–§–∏–Ω–∞–Ω—Å—ã', '–°—Ç—Ä–∏–∫', '–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è'],
                datasets: [{ data: [80, 70, 90, 50], backgroundColor: 'rgba(10, 132, 255, 0.2)', borderColor: '#0A84FF', borderWidth:2, pointRadius:0 }]
            },
            options: { scales: { r: { grid: { color:'rgba(255,255,255,0.1)' }, ticks: { display:false }, pointLabels: { color:'#8E8E93' } } }, plugins: { legend:false } }
        });
        
        // Habit Bar
        const ctxH = document.getElementById('habChart').getContext('2d');
        const habitData = db.habits.map(h => h.done.length);
        const habitLabels = db.habits.map(h => h.name.substring(0,5)); // Short names
        
        if (window.c2) window.c2.destroy();
        window.c2 = new Chart(ctxH, {
            type: 'bar',
            data: {
                labels: habitLabels,
                datasets: [{ data: habitData, backgroundColor: '#BF5AF2', borderRadius:6 }]
            },
            plugins: [ChartDataLabels],
            options: {
                plugins: { legend:false, datalabels: { color:'#fff', anchor:'end', align:'top' } },
                scales: { y: { display:false }, x: { grid:{ display:false }, ticks:{ color:'#8E8E93' } } }
            }
        });
    }

    function toggleHab(id, date) {
        const h = db.habits.find(x => x.id === id);
        if (h.done.includes(date)) h.done = h.done.filter(d => d !== date);
        else h.done.push(date);
        save();
        initCharts(); // Refresh charts
    }

    function addNewHabit() {
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ (–ë–µ–≥, –ß—Ç–µ–Ω–∏–µ...):");
        if(name) {
            db.habits.push({ id:Date.now(), name:name, goal:30, done:[] });
            save();
        }
    }

    function updateRank() {
        const score = db.streak + db.txs.length;
        let rank = "–ù–û–í–ò–ß–û–ö";
        if(score > 50) rank = "–õ–Æ–ë–ò–¢–ï–õ–¨";
        if(score > 150) rank = "–ü–†–û–§–ò";
        if(score > 300) rank = "–õ–ï–ì–ï–ù–î–ê";
        document.getElementById('rankTitle').innerText = rank;
    }

    function changeSalaryDate() {
        const i = document.createElement('input');
        i.type = 'date';
        i.style.position = 'fixed'; i.style.opacity = 0;
        document.body.appendChild(i);
        i.showPicker();
        i.onchange = (e) => { db.salaryDate = e.target.value; save(); i.remove(); }
    }
    
    function switchTab(id, el) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.querySelectorAll('.dock-item').forEach(d => d.classList.remove('active'));
        el.classList.add('active');
        if(id !== 'fin') setTimeout(initCharts, 100);
    }

    function hardReset() { if(confirm("–°—Ç–µ—Ä–µ—Ç—å –≤—Å—ë?")) { localStorage.clear(); location.reload(); } }

    // Start
    load();
</script>
</body>
</html>
