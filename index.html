<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeOS Pure</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- BASE STYLES --- */
        :root {
            --bg: #000000;
            --card: rgba(22, 22, 29, 0.95);
            --primary: #3b82f6;
            --primary-light: rgba(59, 130, 246, 0.15);
            --primary-glow: rgba(59, 130, 246, 0.4);
            --accent: #8b5cf6;
            --danger: #ef4444;
            --danger-light: rgba(239, 68, 68, 0.15);
            --success: #10b981;
            --success-light: rgba(16, 185, 129, 0.15);
            --gold: #f59e0b;
            --gold-light: rgba(245, 158, 11, 0.15);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --nav-bg: rgba(20, 20, 25, 0.95);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
            user-select: none; 
        }
        
        body { 
            background: var(--bg); 
            background-image: radial-gradient(circle at 50% -10%, #111827 0%, #000000 50%);
            color: var(--text-main); 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; 
            padding: 0; 
            overflow-x: hidden; 
            min-height: 100vh;
        }

        /* --- ANIMATIONS --- */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .animate-enter { 
            animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; 
        }
        
        .animate-exit {
            animation: slideOutRight 0.3s ease forwards;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }

        /* --- UI COMPONENTS --- */
        .glass-panel {
            background: var(--card);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            transition: transform 0.2s ease;
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none; 
            color: white; 
            padding: 16px; 
            border-radius: 16px; 
            width: 100%; 
            font-size: 16px; 
            font-weight: 700; 
            box-shadow: 0 4px 15px var(--primary-glow);
            transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            cursor: pointer;
        }
        
        .btn-gold:active { 
            transform: scale(0.96); 
        }

        .btn-secondary {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-main); 
            padding: 12px 16px; 
            border-radius: 12px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.1);
        }

        .input-mod {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
            color: white; 
            padding: 18px;
            border-radius: 16px; 
            width: 100%;
            margin: 8px 0; 
            font-size: 18px;
            text-align: center; 
            font-weight: 600;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }
        
        .input-mod:focus {
            border-color: var(--primary);
        }

        /* --- HEADER & INFO --- */
        .header-row {
            display: flex; 
            justify-content: space-between; 
            align-items: flex-end;
            margin-top: 10px; 
            margin-bottom: 25px;
        }
        
        .info-container {
            position: relative;
            display: inline-block;
        }
        
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 50%;
            font-size: 10px;
            font-weight: 800;
            margin-left: 6px;
            cursor: pointer;
        }
        
        .info-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            border: 1px solid var(--glass-border);
            padding: 12px;
            border-radius: 10px;
            font-size: 11px;
            color: var(--text-muted);
            width: 200px;
            margin-bottom: 8px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
            text-align: left;
            line-height: 1.4;
        }
        
        .info-container:hover .info-tooltip {
            opacity: 1;
        }
        
        .date-wrapper { 
            position: relative; 
            display: inline-block;
        }
        
        .date-input-hidden {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            opacity: 0; 
            z-index: 10; 
            cursor: pointer;
        }
        
        .salary-badge {
            background: rgba(255,255,255,0.05); 
            border: 1px solid var(--glass-border);
            padding: 8px 12px; 
            border-radius: 12px;
            font-size: 12px; 
            color: var(--text-muted); 
            font-weight: 600;
            display: flex; 
            align-items: center; 
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .salary-badge:hover {
            background: rgba(255,255,255,0.08);
        }

        /* --- TASK MANAGER --- */
        .task-manager-container {
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            padding-bottom: 120px;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .task-date {
            font-size: 14px;
            color: var(--text-muted);
        }
        
        .task-stats {
            text-align: center;
            font-size: 32px;
            font-weight: 800;
            margin: 30px 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .add-task-btn {
            width: 100%;
            padding: 18px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            color: var(--text-main);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
            margin-top: 20px;
        }
        
        .add-task-btn:hover {
            background: rgba(255,255,255,0.08);
        }
        
        .task-item {
            background: var(--card);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .task-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 8px;
            border: 2px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .task-checkbox.completed {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .task-content {
            flex: 1;
        }
        
        .task-title {
            font-weight: 600;
            font-size: 15px;
        }
        
        .task-date-small {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* --- NOTES SECTION --- */
        .notes-section {
            margin-top: 30px;
        }
        
        .notes-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .note-card {
            background: var(--card);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px;
            min-height: 140px;
        }
        
        .note-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .note-content {
            color: var(--text-muted);
            font-size: 13px;
            line-height: 1.5;
        }
        
        .note-placeholder {
            color: var(--text-muted);
            opacity: 0.5;
            font-style: italic;
        }

        /* --- HABIT TRACKER --- */
        .habit-tracker-container {
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            padding-bottom: 120px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .month-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-main);
            font-size: 14px;
        }
        
        .current-month {
            font-size: 18px;
            font-weight: 700;
            min-width: 140px;
            text-align: center;
        }
        
        .view-toggle {
            display: flex;
            background: rgba(255,255,255,0.05);
            padding: 4px;
            border-radius: 12px;
        }
        
        .view-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .view-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .calendar-grid {
            margin-bottom: 30px;
        }
        
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .weekday {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
            padding: 5px;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .calendar-day.empty {
            opacity: 0.3;
            cursor: default;
        }
        
        .calendar-day.today {
            background: var(--primary-light);
            color: var(--primary);
        }
        
        .calendar-day.completed {
            background: var(--primary);
            color: white;
        }
        
        .habits-list {
            margin-top: 30px;
        }
        
        .habit-item {
            background: var(--card);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .habit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .habit-name {
            font-weight: 700;
            font-size: 15px;
        }
        
        .habit-progress {
            font-size: 12px;
            color: var(--text-muted);
            background: rgba(255,255,255,0.05);
            padding: 4px 8px;
            border-radius: 10px;
        }
        
        .habit-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        .habit-day {
            aspect-ratio: 1;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .habit-day.empty {
            background: rgba(255,255,255,0.05);
            color: var(--text-muted);
        }
        
        .habit-day.completed {
            background: var(--primary);
            color: white;
        }

        /* --- INSIGHTS --- */
        .insights-container {
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            padding-bottom: 120px;
        }
        
        .insights-tabs {
            display: flex;
            background: rgba(255,255,255,0.05);
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .insight-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .insight-tab.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .time-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .time-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .time-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .progress-container {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .progress-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--primary) 0% 50%, rgba(255,255,255,0.05) 50% 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            position: relative;
        }
        
        .progress-inner {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .progress-value {
            font-size: 24px;
            font-weight: 800;
        }
        
        .progress-label {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 12px;
        }
        
        .stat-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: 700;
        }
        
        .daily-graph {
            margin-top: 30px;
        }

        /* --- FINANCE TAB --- */
        .finance-container {
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            padding-bottom: 120px;
        }
        
        .stat-card {
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 10px;
        }
        
        .stat-card.safe {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .stat-card.fixed {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
        }
        
        .stat-label {
            font-size: 11px; 
            font-weight: 700; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }
        
        .tx-row {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.03);
            transition: all 0.3s ease;
        }
        
        .tx-row.deleting {
            animation: slideOutRight 0.3s ease forwards;
        }
        
        .tx-category {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tx-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .tx-icon.income {
            background: var(--success-light);
            color: var(--success);
        }
        
        .tx-icon.expense {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        .tx-details {
            display: flex;
            flex-direction: column;
        }
        
        .tx-amount {
            font-weight: 700;
            font-size: 15px;
        }
        
        .tx-amount.positive {
            color: var(--success);
        }
        
        .tx-amount.negative {
            color: var(--text-main);
        }
        
        .tx-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            opacity: 0.5;
            transition: all 0.2s ease;
        }
        
        .tx-delete:hover {
            opacity: 1;
            color: var(--danger);
        }

        /* --- SEGMENTED CONTROL --- */
        .seg-control {
            display: flex; 
            background: rgba(255,255,255,0.05);
            padding: 4px; 
            border-radius: 12px; 
            margin-bottom: 15px;
        }
        
        .seg-btn {
            flex: 1; 
            padding: 8px; 
            border: none; 
            background: transparent;
            color: var(--text-muted); 
            font-size: 12px; 
            font-weight: 700;
            border-radius: 10px; 
            transition: 0.3s;
            cursor: pointer;
        }
        
        .seg-btn.active { 
            background: rgba(255,255,255,0.1); 
            color: white; 
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--card);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            animation: slideUp 0.4s ease;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
        }
        
        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .modal-input {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            color: white;
            font-size: 16px;
            font-family: inherit;
        }
        
        .modal-input:focus {
            border-color: var(--primary);
        }

        /* --- TAB LOGIC --- */
        .tab-content { 
            display: none; 
            max-width: 500px; 
            margin: 0 auto;
            padding-bottom: 120px;
        }
        
        .tab-content.active { 
            display: block; 
        }

        /* --- SETUP SCREEN --- */
        #setupOverlay { 
            position: fixed; 
            inset: 0; 
            z-index: 5000; 
            background: #000; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 40px; 
        }
        
        .setup-card { 
            width: 100%; 
            max-width: 350px; 
            animation: slideUp 0.8s ease; 
        }

        /* --- NAVIGATION --- */
        .nav-dock {
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%);
            width: 90%; 
            max-width: 400px; 
            height: 75px;
            background: var(--nav-bg); 
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border); 
            border-radius: 24px;
            display: flex; 
            justify-content: space-around; 
            align-items: center;
            z-index: 100; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        
        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 4px;
            color: var(--text-muted); 
            opacity: 0.6; 
            transition: 0.3s; 
            cursor: pointer;
            padding: 10px;
        }
        
        .nav-item.active { 
            opacity: 1; 
            color: var(--primary); 
            transform: translateY(-2px); 
        }
        
        .nav-icon { 
            font-size: 22px; 
        }
        
        .nav-label { 
            font-size: 10px; 
            font-weight: 600;
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 480px) {
            .glass-panel {
                padding: 16px;
                border-radius: 20px;
            }
            
            .nav-dock {
                width: 95%;
                bottom: 15px;
                height: 70px;
            }
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Setup Screen -->
    <div id="setupOverlay">
        <div class="setup-card glass-panel">
            <h1 style="text-align:center; font-size:28px; font-weight:800; margin-bottom:10px;">LifeOS <span style="color:var(--accent)">Pure</span></h1>
            <p style="text-align:center; color:var(--text-muted); font-size:14px; margin-bottom:30px;">–°–∏—Å—Ç–µ–º–∞ —á–∏—Å—Ç–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è</p>
            
            <div style="margin-bottom: 8px; font-size: 12px; color: var(--text-muted); font-weight: 600;">
                –°–∫–æ–ª—å–∫–æ —É –≤–∞—Å —Å–µ–π—á–∞—Å –¥–µ–Ω–µ–≥?
                <span class="info-container">
                    <span class="info-icon">i</span>
                    <div class="info-tooltip">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –Ω–∞–ª–∏—á–Ω—ã–º–∏ –∏ –Ω–∞ –∫–∞—Ä—Ç–∞—Ö</div>
                </span>
            </div>
            <input type="number" id="initBalance" class="input-mod" placeholder="0">
            
            <div style="margin: 20px 0 8px; font-size: 12px; color: var(--text-muted); font-weight: 600;">
                –ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (‚ÇΩ)
                <span class="info-container">
                    <span class="info-icon">i</span>
                    <div class="info-tooltip">–°—É–º–º–∞, –∫–æ—Ç–æ—Ä—É—é –≤—ã –¥–æ–ª–∂–Ω—ã –ø–ª–∞—Ç–∏—Ç—å –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü (–∞—Ä–µ–Ω–¥–∞, –∫—Ä–µ–¥–∏—Ç—ã, –∫–æ–º–º—É–Ω–∞–ª–∫–∞)</div>
                </span>
            </div>
            <input type="number" id="initFixed" class="input-mod" placeholder="0">
            
            <div style="margin: 20px 0 8px; font-size: 12px; color: var(--text-muted); font-weight: 600;">
                –î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞—Ä–ø–ª–∞—Ç—ã
                <span class="info-container">
                    <span class="info-icon">i</span>
                    <div class="info-tooltip">–ö–æ–≥–¥–∞ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –∑–∞—Ä–ø–ª–∞—Ç—É? –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–Ω–µ–≤–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç–∞</div>
                </span>
            </div>
            <input type="date" id="initDate" class="input-mod" style="color-scheme: dark;">
            
            <button onclick="completeSetup()" class="btn-gold" style="margin-top:30px;">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É</button>
        </div>
    </div>

    <!-- Tasks Tab -->
    <div id="tab-tasks" class="tab-content">
        <div class="task-manager-container">
            <div class="task-header animate-enter">
                <div>
                    <div style="font-size: 28px; font-weight: 800;">–°–µ–≥–æ–¥–Ω—è</div>
                    <div class="task-date" id="todayDate">–í—Å, 1 —Ñ–µ–≤.</div>
                </div>
                <button class="nav-icon" style="background:none; border:none; color:var(--text-muted); font-size:20px;">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>

            <div class="task-stats animate-enter">
                <div id="taskProgress">0 / 0</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">–≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
            </div>

            <div id="tasksList" class="animate-enter"></div>

            <div class="empty-state animate-enter" id="emptyTasksState" style="display: none;">
                <div class="empty-state-icon">üìã</div>
                <div style="font-weight: 700; margin-bottom: 10px;">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–¥–∞—á –Ω–µ—Ç</div>
                <div style="color: var(--text-muted); font-size: 14px;">–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É</div>
            </div>

            <button onclick="showAddTaskModal()" class="add-task-btn animate-enter">
                <i class="fas fa-plus"></i>
                –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
            </button>

            <div class="notes-section animate-enter">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <div style="font-size: 18px; font-weight: 700;">–ï—â–µ</div>
                </div>
                
                <div class="notes-grid">
                    <div class="note-card">
                        <div class="note-title">–ó–∞–º–µ—Ç–∫–∏</div>
                        <div class="note-content note-placeholder">–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å</div>
                    </div>
                    <div class="note-card">
                        <div class="note-title">–£—Ä–æ–∫ –¥–Ω—è</div>
                        <div class="note-content note-placeholder">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç...</div>
                    </div>
                    <div class="note-card">
                        <div class="note-title">–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å</div>
                        <div class="note-content note-placeholder">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç...</div>
                    </div>
                    <div class="note-card">
                        <div class="note-title">–ú—ã—Å–ª–∏</div>
                        <div class="note-content note-placeholder">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Habits Tab -->
    <div id="tab-hab" class="tab-content">
        <div class="habit-tracker-container">
            <div class="calendar-header animate-enter">
                <div class="month-nav">
                    <button class="nav-btn" onclick="changeMonth(-1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="current-month" id="currentMonth">–§–µ–≤—Ä–∞–ª—å 2026–≥.</div>
                    <button class="nav-btn" onclick="changeMonth(1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" onclick="setHabitView('week')">–ù–µ–¥–µ–ª—è</button>
                    <button class="view-btn" onclick="setHabitView('month')">–ú–µ—Å—è—Ü</button>
                </div>
            </div>

            <div class="calendar-grid animate-enter" style="animation-delay: 0.1s;">
                <div class="calendar-weekdays">
                    <div class="weekday">–ü–ù</div>
                    <div class="weekday">–í–¢</div>
                    <div class="weekday">–°–†</div>
                    <div class="weekday">–ß–¢</div>
                    <div class="weekday">–ü–¢</div>
                    <div class="weekday">–°–ë</div>
                    <div class="weekday">–í–°</div>
                </div>
                <div class="calendar-days" id="calendarDays"></div>
            </div>

            <div class="habits-list" id="habitsListContainer"></div>

            <button onclick="showAddHabitModal()" class="add-task-btn animate-enter" style="animation-delay: 0.2s;">
                <i class="fas fa-plus"></i>
                –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É
            </button>
        </div>
    </div>

    <!-- Finance Tab -->
    <div id="tab-fin" class="tab-content active">
        <div class="finance-container">
            <div class="header-row animate-enter">
                <div>
                    <div class="stat-label" style="margin-bottom:4px;">–ë—é–¥–∂–µ—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                        <span class="info-container">
                            <span class="info-icon">i</span>
                            <div class="info-tooltip">–°–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç –æ—Å—Ç–∞—Ç–∫–∞ –¥–æ –∑–∞—Ä–ø–ª–∞—Ç—ã</div>
                        </span>
                    </div>
                    <div id="dailyVal" style="font-size: 42px; font-weight: 800; letter-spacing: -1px; background: -webkit-linear-gradient(0deg, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">0 ‚ÇΩ</div>
                </div>
                
                <div class="date-wrapper">
                    <input type="date" class="date-input-hidden" onchange="updateSalaryDate(this.value)">
                    <div class="salary-badge">
                        <span>üìÖ</span>
                        <span id="salaryDateText">...</span>
                    </div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:16px;" class="animate-enter" style="animation-delay: 0.1s;">
                <div class="stat-card safe">
                    <div class="stat-label" style="color:var(--gold)">
                        –°–µ–π—Ñ
                        <span class="info-container">
                            <span class="info-icon">i</span>
                            <div class="info-tooltip">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è. 20% –æ—Ç –∫–∞–∂–¥–æ–≥–æ –¥–æ—Ö–æ–¥–∞ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —Å—é–¥–∞</div>
                        </span>
                    </div>
                    <div id="saveVal" style="font-size:20px; font-weight:800;">0 ‚ÇΩ</div>
                </div>
                <div class="stat-card fixed">
                    <div class="stat-label" style="color:var(--text-muted)">
                        –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
                        <span class="info-container">
                            <span class="info-icon">i</span>
                            <div class="info-tooltip">–°—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–∞—Ä–µ–Ω–¥–∞, –∫—Ä–µ–¥–∏—Ç—ã, –∫–æ–º–º—É–Ω–∞–ª–∫–∞). –ü–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ –¥–æ—Ö–æ–¥–æ–≤</div>
                        </span>
                    </div>
                    <div id="fixVal" style="font-size:16px; font-weight:800;">0 / 0</div>
                </div>
            </div>

            <div class="glass-panel animate-enter" style="padding:15px; display:flex; gap:10px; animation-delay: 0.2s;">
                <button onclick="showIncomeModal()" class="btn-gold" style="font-size:14px; padding:12px; flex:1;">+ –î–æ—Ö–æ–¥</button>
                <button onclick="showExpenseModal()" class="btn-gold" style="background:rgba(255,255,255,0.05); font-size:14px; padding:12px; flex:1;">- –¢—Ä–∞—Ç–∞</button>
            </div>

            <div class="animate-enter" style="animation-delay: 0.3s;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                     <div class="stat-label">–û—á–µ—Ä–µ–¥—å –ø–ª–∞—Ç–µ–∂–µ–π</div>
                     <button onclick="addFixedTask()" style="background:none; border:none; color:var(--primary); font-size:20px; font-weight:800; cursor: pointer;">+</button>
                </div>
                <div id="fixedTasksList"></div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px; margin-bottom:10px;">
                    <div class="stat-label">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</div>
                </div>
                
                <div class="seg-control">
                    <button class="seg-btn active" onclick="setTxFilter('ALL', this)">–í–°–ï</button>
                    <button class="seg-btn" onclick="setTxFilter('INC', this)">–î–û–•–û–î–´</button>
                    <button class="seg-btn" onclick="setTxFilter('EXP', this)">–¢–†–ê–¢–´</button>
                </div>
                
                <div class="glass-panel" id="txList" style="padding:5px 0;"></div>
            </div>
        </div>
    </div>

    <!-- Insights Tab -->
    <div id="tab-ins" class="tab-content">
        <div class="insights-container">
            <h1 class="animate-enter" style="margin-bottom:10px; font-size:28px;">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
            <p class="animate-enter text-muted" style="margin-bottom:30px;">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –≤–∞—à–∏—Ö –∑–∞–¥–∞—á –∏ –ø—Ä–∏–≤—ã—á–µ–∫</p>
            
            <!-- Tabs -->
            <div class="insights-tabs animate-enter">
                <button class="insight-tab active" onclick="setInsightType('habits', this)">–ü—Ä–∏–≤—ã—á–∫–∏</button>
                <button class="insight-tab" onclick="setInsightType('finance', this)">–§–∏–Ω–∞–Ω—Å—ã</button>
            </div>
            
            <!-- Time Filter -->
            <div class="time-filter animate-enter" style="animation-delay: 0.1s;">
                <button class="time-btn active" onclick="setTimeFilter('week', this)">–ù–µ–¥–µ–ª—è</button>
                <button class="time-btn" onclick="setTimeFilter('month', this)">–ú–µ—Å—è—Ü</button>
                <button class="time-btn" onclick="setTimeFilter('year', this)">–ì–æ–¥</button>
            </div>
            
            <!-- Habits Insights -->
            <div id="habitsInsights" class="animate-enter" style="animation-delay: 0.2s;">
                <div class="progress-container">
                    <div class="progress-circle">
                        <div class="progress-inner">
                            <div class="progress-value" id="habitsProgressValue">0%</div>
                            <div class="progress-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–∏–≤—ã—á–µ–∫</div>
                        <div class="stat-value" id="totalHabits">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                        <div class="stat-value" id="completedHabits">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                        <div class="stat-value" id="incompleteHabits">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–π –¥–µ–Ω—å</div>
                        <div class="stat-value" id="productiveDay">-</div>
                    </div>
                </div>
                
                <div class="glass-panel daily-graph">
                    <div class="stat-label" style="margin-bottom:15px;">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –¥–Ω—è–º</div>
                    <canvas id="habitsChart" height="200"></canvas>
                </div>
            </div>
            
            <!-- Finance Insights -->
            <div id="financeInsights" class="animate-enter" style="animation-delay: 0.2s; display: none;">
                <div class="progress-container">
                    <div class="progress-circle">
                        <div class="progress-inner">
                            <div class="progress-value" id="financeProgressValue">0%</div>
                            <div class="progress-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">–î–æ—Ö–æ–¥—ã</div>
                        <div class="stat-value" id="totalIncome">0 ‚ÇΩ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–†–∞—Å—Ö–æ–¥—ã</div>
                        <div class="stat-value" id="totalExpenses">0 ‚ÇΩ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–ù–∞–∫–æ–ø–ª–µ–Ω–æ</div>
                        <div class="stat-value" id="totalSavings">0 ‚ÇΩ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–≠–∫–æ–Ω–æ–º–∏—è</div>
                        <div class="stat-value" id="savingsRate">0%</div>
                    </div>
                </div>
                
                <div class="glass-panel daily-graph">
                    <div class="stat-label" style="margin-bottom:15px;">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ—Ç–æ–∫</div>
                    <canvas id="financeChart" height="200"></canvas>
                </div>
            </div>
            
            <button onclick="showResetModal()" class="animate-enter" style="animation-delay: 0.4s; width:100%; padding:15px; border-radius:12px; background:rgba(239, 68, 68, 0.1); color:var(--danger); border:1px solid rgba(239, 68, 68, 0.3); font-weight:700; margin-top:20px; cursor: pointer;">‚ö† –°–±—Ä–æ—Å —Å–∏—Å—Ç–µ–º—ã</button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-dock">
        <div class="nav-item" onclick="switchTab('tasks', this)">
            <span class="nav-icon">‚úì</span>
            <span class="nav-label">–ó–∞–¥–∞—á–∏</span>
        </div>
        <div class="nav-item" onclick="switchTab('hab', this)">
            <span class="nav-icon">‚ö°</span>
            <span class="nav-label">–ü—Ä–∏–≤—ã—á–∫–∏</span>
        </div>
        <div class="nav-item active" onclick="switchTab('fin', this)">
            <span class="nav-icon">‚ùñ</span>
            <span class="nav-label">–°–≤–æ–¥–∫–∞</span>
        </div>
        <div class="nav-item" onclick="switchTab('ins', this)">
            <span class="nav-icon">‚öõ</span>
            <span class="nav-label">–ò—Ç–æ–≥–∏</span>
        </div>
    </div>

    <!-- Modals -->
    <div id="incomeModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</div>
                <button class="modal-close" onclick="closeModal('incomeModal')">√ó</button>
            </div>
            <div class="modal-form">
                <input type="number" id="incomeAmount" class="modal-input" placeholder="–°—É–º–º–∞ (‚ÇΩ)">
                <input type="text" id="incomeCategory" class="modal-input" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–∑–∞—Ä–ø–ª–∞—Ç–∞, –ø–æ–¥–∞—Ä–æ–∫)">
                <button onclick="addIncome()" class="btn-gold">–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</button>
            </div>
        </div>
    </div>

    <div id="expenseModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞—Ç—É</div>
                <button class="modal-close" onclick="closeModal('expenseModal')">√ó</button>
            </div>
            <div class="modal-form">
                <input type="number" id="expenseAmount" class="modal-input" placeholder="–°—É–º–º–∞ (‚ÇΩ)">
                <input type="text" id="expenseCategory" class="modal-input" placeholder="–ù–∞ —á—Ç–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏">
                <button onclick="addExpense()" class="btn-gold">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞—Ç—É</button>
            </div>
        </div>
    </div>

    <div id="addTaskModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</div>
                <button class="modal-close" onclick="closeModal('addTaskModal')">√ó</button>
            </div>
            <div class="modal-form">
                <input type="text" id="taskName" class="modal-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É">
                <input type="date" id="taskDate" class="modal-input" style="color-scheme: dark;">
                <div style="display: flex; gap: 10px;">
                    <button onclick="addTask()" class="btn-gold" style="flex: 1;">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div id="addHabitModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞</div>
                <button class="modal-close" onclick="closeModal('addHabitModal')">√ó</button>
            </div>
            <div class="modal-form">
                <input type="text" id="habitName" class="modal-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏">
                <div style="font-size: 12px; color: var(--text-muted); text-align: center;">
                    –ü—Ä–∏–≤—ã—á–∫–∞ –±—É–¥–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
                </div>
                <button onclick="addHabit()" class="btn-gold">–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</button>
            </div>
        </div>
    </div>

    <div id="resetModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–°–±—Ä–æ—Å —Å–∏—Å—Ç–µ–º—ã</div>
                <button class="modal-close" onclick="closeModal('resetModal')">√ó</button>
            </div>
            <div class="modal-form">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; color: var(--danger); margin-bottom: 10px;">‚ö†</div>
                    <div style="color: var(--text-main); font-weight: 600; margin-bottom: 10px;">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</div>
                    <div style="color: var(--text-muted); font-size: 14px;">–í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</div>
                </div>
                <button onclick="hardReset()" style="background: var(--danger);" class="btn-gold">–î–∞, —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
                <button onclick="closeModal('resetModal')" style="background: rgba(255,255,255,0.05); margin-top: 10px;" class="btn-gold">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.enableClosingConfirmation();

    // --- GLOBAL DATA ---
    let db = {
        setup: false,
        balance: 0,
        fixedTarget: 0,
        fixedCurrent: 0,
        savings: 0,
        txs: [],
        fixedTasks: [],
        habits: [],
        tasks: [],
        notes: {
            notes: "",
            lesson: "",
            gratitude: "",
            thoughts: ""
        },
        salaryDate: null,
        currentMonth: new Date().getMonth(),
        currentYear: new Date().getFullYear(),
        habitView: 'month',
        insightType: 'habits',
        timeFilter: 'week'
    };
    
    let currentFilter = 'ALL';

    // --- CORE FUNCTIONS ---
    function load() {
        const saved = localStorage.getItem('lifeos_v13_pure');
        if(saved) {
            const parsed = JSON.parse(saved);
            db = {...db, ...parsed};
            
            // Initialize new fields if they don't exist
            if(!db.tasks) db.tasks = [];
            if(!db.notes) db.notes = { notes: "", lesson: "", gratitude: "", thoughts: "" };
            if(!db.currentMonth) db.currentMonth = new Date().getMonth();
            if(!db.currentYear) db.currentYear = new Date().getFullYear();
            if(!db.habitView) db.habitView = 'month';
            if(!db.insightType) db.insightType = 'habits';
            if(!db.timeFilter) db.timeFilter = 'week';
        }
        
        if(db.setup && !db.salaryDate) {
            let d = new Date();
            d.setDate(d.getDate() + 30);
            db.salaryDate = d.toISOString().split('T')[0];
        }

        if(!db.setup) {
            document.getElementById('setupOverlay').style.display = 'flex';
            const today = new Date();
            document.getElementById('initDate').valueAsDate = today;
            document.getElementById('initDate').min = today.toISOString().split('T')[0];
        }
        
        render();
    }

    function save() {
        localStorage.setItem('lifeos_v13_pure', JSON.stringify(db));
        render();
    }

    function completeSetup() {
        const balance = +document.getElementById('initBalance').value;
        const fixed = +document.getElementById('initFixed').value;
        const salaryDate = document.getElementById('initDate').value;
        
        if(!salaryDate) {
            alert("–î–∞—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞!");
            return;
        }
        
        if(isNaN(balance) || balance < 0) {
            alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞!");
            return;
        }
        
        if(isNaN(fixed) || fixed < 0) {
            alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π!");
            return;
        }
        
        db.balance = balance;
        db.fixedTarget = fixed;
        db.salaryDate = salaryDate;
        db.setup = true;
        
        save();
        document.getElementById('setupOverlay').style.display = 'none';
    }

    // --- TASK MANAGEMENT ---
    function showAddTaskModal() {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        document.getElementById('taskDate').valueAsDate = tomorrow;
        document.getElementById('addTaskModal').classList.remove('hidden');
        document.getElementById('taskName').focus();
    }

    function addTask() {
        const name = document.getElementById('taskName').value;
        const date = document.getElementById('taskDate').value;
        
        if(!name || name.trim() === '') {
            alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏!");
            return;
        }
        
        db.tasks.push({
            id: Date.now(),
            name: name.trim(),
            date: date,
            completed: false,
            createdAt: new Date().toISOString()
        });
        
        closeModal('addTaskModal');
        save();
    }

    function toggleTask(id) {
        const task = db.tasks.find(t => t.id === id);
        if(task) {
            task.completed = !task.completed;
            save();
        }
    }

    function deleteTask(id) {
        db.tasks = db.tasks.filter(t => t.id !== id);
        save();
    }

    function renderTasks() {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        
        // Update date display
        const options = { weekday: 'short', day: 'numeric', month: 'short' };
        document.getElementById('todayDate').textContent = today.toLocaleDateString('ru-RU', options);
        
        // Filter today's tasks
        const todayTasks = db.tasks.filter(task => task.date === todayStr);
        const completedCount = todayTasks.filter(t => t.completed).length;
        const totalCount = todayTasks.length;
        
        // Update progress
        document.getElementById('taskProgress').textContent = `${completedCount} / ${totalCount}`;
        
        const tasksList = document.getElementById('tasksList');
        const emptyState = document.getElementById('emptyTasksState');
        
        if(todayTasks.length > 0) {
            emptyState.style.display = 'none';
            tasksList.innerHTML = todayTasks.map(task => `
                <div class="task-item animate-enter">
                    <div class="task-checkbox ${task.completed ? 'completed' : ''}" 
                         onclick="toggleTask(${task.id})">
                        ${task.completed ? '‚úì' : ''}
                    </div>
                    <div class="task-content">
                        <div class="task-title">${task.name}</div>
                        <div class="task-date-small">–°–µ–≥–æ–¥–Ω—è</div>
                    </div>
                    <button onclick="deleteTask(${task.id})" class="tx-delete">‚úï</button>
                </div>
            `).join('');
        } else {
            tasksList.innerHTML = '';
            emptyState.style.display = 'block';
        }
    }

    // --- HABIT MANAGEMENT ---
    function changeMonth(delta) {
        let newMonth = db.currentMonth + delta;
        let newYear = db.currentYear;
        
        if(newMonth < 0) {
            newMonth = 11;
            newYear--;
        } else if(newMonth > 11) {
            newMonth = 0;
            newYear++;
        }
        
        db.currentMonth = newMonth;
        db.currentYear = newYear;
        renderHabits();
    }

    function setHabitView(view) {
        db.habitView = view;
        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        renderHabits();
    }

    function showAddHabitModal() {
        document.getElementById('addHabitModal').classList.remove('hidden');
        document.getElementById('habitName').focus();
    }

    function addHabit() {
        const name = document.getElementById('habitName').value;
        if(!name || name.trim() === '') {
            alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏!");
            return;
        }
        
        db.habits.push({
            id: Date.now(),
            name: name.trim(),
            completedDays: [],
            goal: 30, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ü–µ–ª—å - 30 –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü
            createdAt: new Date().toISOString()
        });
        
        closeModal('addHabitModal');
        save();
    }

    function toggleHabitDay(habitId, dateStr) {
        const habit = db.habits.find(h => h.id === habitId);
        if(!habit) return;
        
        const index = habit.completedDays.indexOf(dateStr);
        if(index === -1) {
            habit.completedDays.push(dateStr);
        } else {
            habit.completedDays.splice(index, 1);
        }
        
        save();
    }

    function getDaysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
    }

    function renderHabits() {
        const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
        document.getElementById('currentMonth').textContent = `${monthNames[db.currentMonth]} ${db.currentYear}–≥.`;
        
        // Render calendar days
        const firstDay = new Date(db.currentYear, db.currentMonth, 1);
        const startingDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Monday = 0
        const daysInMonth = getDaysInMonth(db.currentYear, db.currentMonth);
        const today = new Date();
        
        let calendarHTML = '';
        
        // Empty days at start
        for(let i = 0; i < startingDay; i++) {
            calendarHTML += `<div class="calendar-day empty"></div>`;
        }
        
        // Days of the month
        for(let day = 1; day <= daysInMonth; day++) {
            const date = new Date(db.currentYear, db.currentMonth, day);
            const dateStr = date.toISOString().split('T')[0];
            const isToday = date.toDateString() === today.toDateString();
            
            // Check if any habit is completed for this day
            let isCompleted = false;
            db.habits.forEach(habit => {
                if(habit.completedDays.includes(dateStr)) {
                    isCompleted = true;
                }
            });
            
            let dayClass = 'calendar-day';
            if(isToday) dayClass += ' today';
            if(isCompleted) dayClass += ' completed';
            
            calendarHTML += `<div class="${dayClass}">${day}</div>`;
        }
        
        document.getElementById('calendarDays').innerHTML = calendarHTML;
        
        // Render habits list
        const habitsContainer = document.getElementById('habitsListContainer');
        
        if(db.habits.length > 0) {
            habitsContainer.innerHTML = db.habits.map((habit, index) => {
                // Calculate progress for current month
                const monthStart = new Date(db.currentYear, db.currentMonth, 1).toISOString().split('T')[0];
                const monthEnd = new Date(db.currentYear, db.currentMonth + 1, 0).toISOString().split('T')[0];
                
                const monthCompleted = habit.completedDays.filter(date => {
                    return date >= monthStart && date <= monthEnd;
                }).length;
                
                // Generate habit calendar for current month
                let habitCalendarHTML = '';
                const daysInMonth = getDaysInMonth(db.currentYear, db.currentMonth);
                
                for(let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(db.currentYear, db.currentMonth, day);
                    const dateStr = date.toISOString().split('T')[0];
                    const isCompleted = habit.completedDays.includes(dateStr);
                    
                    let dayClass = 'habit-day';
                    if(isCompleted) {
                        dayClass += ' completed';
                    } else {
                        dayClass += ' empty';
                    }
                    
                    habitCalendarHTML += `<div class="${dayClass}" 
                                           onclick="toggleHabitDay(${habit.id}, '${dateStr}')">${day}</div>`;
                }
                
                return `
                    <div class="habit-item animate-enter" style="animation-delay: ${index * 0.05}s">
                        <div class="habit-header">
                            <div class="habit-name">${habit.name}</div>
                            <div class="habit-progress">${monthCompleted}/${daysInMonth}</div>
                        </div>
                        <div class="habit-calendar">
                            ${habitCalendarHTML}
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            habitsContainer.innerHTML = `
                <div class="empty-state animate-enter">
                    <div class="empty-state-icon">üìã</div>
                    <div style="font-weight: 700; margin-bottom: 10px;">–ù–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫</div>
                    <div style="color: var(--text-muted); font-size: 14px;">–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É</div>
                </div>
            `;
        }
    }

    // --- FINANCE MANAGEMENT ---
    function smartDistribute(val) {
        let toSave = Math.floor(val * 0.2);
        let rem = val - toSave;
        let needed = db.fixedTarget - db.fixedCurrent;
        let toFix = 0;
        
        if(needed > 0) { 
            toFix = Math.min(rem, needed); 
            rem -= toFix; 
        }
        
        let toBalance = rem;
        return { toSave, toFix, toBalance };
    }

    function showIncomeModal() {
        document.getElementById('incomeModal').classList.remove('hidden');
        document.getElementById('incomeAmount').focus();
    }

    function showExpenseModal() {
        document.getElementById('expenseModal').classList.remove('hidden');
        document.getElementById('expenseAmount').focus();
    }

    function addIncome() {
        const amount = +document.getElementById('incomeAmount').value;
        const category = document.getElementById('incomeCategory').value || "–î–æ—Ö–æ–¥";
        
        if(!amount || amount <= 0) {
            alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!");
            return;
        }
        
        const distribution = smartDistribute(amount);
        
        // Save distribution to transaction for correct deletion
        const tx = {
            id: Date.now(),
            val: amount,
            type: 'inc',
            cat: category,
            t: new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'}),
            date: new Date().toLocaleDateString('ru-RU'),
            fullDate: new Date().toISOString(),
            distribution: distribution // Save distribution data
        };
        
        // Apply distribution
        db.savings += distribution.toSave;
        db.fixedCurrent += distribution.toFix;
        db.balance += distribution.toBalance;
        
        db.txs.unshift(tx);
        
        closeModal('incomeModal');
        save();
        
        // Animation
        document.getElementById('saveVal').classList.add('pulse-animation');
        setTimeout(() => {
            document.getElementById('saveVal').classList.remove('pulse-animation');
        }, 1000);
    }

    function addExpense() {
        const amount = +document.getElementById('expenseAmount').value;
        const category = document.getElementById('expenseCategory').value || "–ü—Ä–æ—á–µ–µ";
        
        if(!amount || amount <= 0) {
            alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!");
            return;
        }
        
        if(amount > db.balance) {
            alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");
            return;
        }
        
        db.balance -= amount;
        
        db.txs.unshift({
            id: Date.now(),
            val: amount,
            type: 'exp',
            cat: category,
            t: new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'}),
            date: new Date().toLocaleDateString('ru-RU'),
            fullDate: new Date().toISOString()
        });
        
        closeModal('expenseModal');
        save();
    }

    function deleteTx(id) {
        const txElement = document.getElementById(`tx-${id}`);
        if(txElement) {
            txElement.classList.add('deleting');
            
            setTimeout(() => {
                const tx = db.txs.find(x => x.id === id);
                if(tx) {
                    // Correctly reverse distribution for income transactions
                    if(tx.type === 'inc' && tx.distribution) {
                        db.savings -= tx.distribution.toSave;
                        db.fixedCurrent -= tx.distribution.toFix;
                        db.balance -= tx.distribution.toBalance;
                    } else if(tx.type === 'exp') {
                        db.balance += tx.val;
                    }
                    
                    db.txs = db.txs.filter(x => x.id !== id);
                    save();
                }
            }, 300);
        }
    }

    function updateSalaryDate(val) {
        if(val) {
            db.salaryDate = val;
            save();
        }
    }

    function setTxFilter(type, el) {
        currentFilter = type;
        document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        renderFinance();
    }

    function addFixedTask() {
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:");
        if(!name) return;
        
        const amount = +prompt("–°—É–º–º–∞ (‚ÇΩ):");
        if(!amount || amount <= 0) return;
        
        db.fixedTasks.push({
            id: Date.now(),
            name: name,
            amount: amount
        });
        
        save();
    }

    function payFixed(id, amount) {
        if(db.fixedCurrent >= amount) {
            db.fixedCurrent -= amount;
            db.fixedTasks = db.fixedTasks.filter(t => t.id !== id);
            
            db.txs.unshift({
                id: Date.now(),
                val: amount,
                type: 'exp',
                cat: '–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂',
                t: new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'}),
                date: new Date().toLocaleDateString('ru-RU'),
                fullDate: new Date().toISOString()
            });
            
            save();
        } else {
            alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ '–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ'!");
        }
    }

    // --- INSIGHTS ---
    function setInsightType(type, el) {
        db.insightType = type;
        document.querySelectorAll('.insight-tab').forEach(btn => btn.classList.remove('active'));
        el.classList.add('active');
        
        if(type === 'habits') {
            document.getElementById('habitsInsights').style.display = 'block';
            document.getElementById('financeInsights').style.display = 'none';
            renderHabitsInsights();
        } else {
            document.getElementById('habitsInsights').style.display = 'none';
            document.getElementById('financeInsights').style.display = 'block';
            renderFinanceInsights();
        }
    }

    function setTimeFilter(filter, el) {
        db.timeFilter = filter;
        document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
        el.classList.add('active');
        
        if(db.insightType === 'habits') {
            renderHabitsInsights();
        } else {
            renderFinanceInsights();
        }
    }

    function renderHabitsInsights() {
        let habitsData = db.habits;
        let timeData = [];
        
        // Filter by time
        const now = new Date();
        let startDate;
        
        switch(db.timeFilter) {
            case 'week':
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 7);
                break;
            case 'month':
                startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                break;
            case 'year':
                startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                break;
        }
        
        // Calculate statistics
        let totalPossible = 0;
        let totalCompleted = 0;
        let dayStats = Array(7).fill(0).map(() => ({ completed: 0, total: 0 }));
        
        habitsData.forEach(habit => {
            habit.completedDays.forEach(dateStr => {
                const date = new Date(dateStr);
                if(date >= startDate) {
                    totalPossible++;
                    totalCompleted++;
                    const dayIndex = date.getDay();
                    dayStats[dayIndex].completed++;
                    dayStats[dayIndex].total++;
                }
            });
        });
        
        // Calculate progress percentage
        const progressPercent = totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;
        document.getElementById('habitsProgressValue').textContent = `${progressPercent}%`;
        
        // Update stats
        document.getElementById('totalHabits').textContent = habitsData.length;
        document.getElementById('completedHabits').textContent = totalCompleted;
        document.getElementById('incompleteHabits').textContent = Math.max(0, totalPossible - totalCompleted);
        
        // Find most productive day
        let maxCompletion = 0;
        let productiveDayIndex = -1;
        const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
        
        dayStats.forEach((stat, index) => {
            if(stat.total > 0) {
                const completionRate = stat.completed / stat.total;
                if(completionRate > maxCompletion) {
                    maxCompletion = completionRate;
                    productiveDayIndex = index;
                }
            }
        });
        
        document.getElementById('productiveDay').textContent = productiveDayIndex >= 0 ? dayNames[productiveDayIndex] : '-';
        
        // Update chart
        const ctx = document.getElementById('habitsChart').getContext('2d');
        if(window.habitsChart) window.habitsChart.destroy();
        
        const labels = ['–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë', '–í–°'];
        const completedData = dayStats.slice(1).concat(dayStats[0]).map(stat => stat.completed);
        
        window.habitsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ',
                    data: completedData,
                    backgroundColor: '#3b82f6',
                    borderRadius: 6,
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                }
            }
        });
    }

    function renderFinanceInsights() {
        let transactions = db.txs;
        let startDate;
        const now = new Date();
        
        // Filter by time period
        switch(db.timeFilter) {
            case 'week':
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 7);
                break;
            case 'month':
                startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                break;
            case 'year':
                startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                break;
        }
        
        const filteredTxs = transactions.filter(tx => {
            const txDate = new Date(tx.fullDate || tx.date);
            return txDate >= startDate;
        });
        
        // Calculate statistics
        const income = filteredTxs
            .filter(tx => tx.type === 'inc')
            .reduce((sum, tx) => sum + tx.val, 0);
        
        const expenses = filteredTxs
            .filter(tx => tx.type === 'exp')
            .reduce((sum, tx) => sum + tx.val, 0);
        
        const savingsRate = income > 0 ? Math.round((db.savings / income) * 100) : 0;
        
        // Update display
        document.getElementById('financeProgressValue').textContent = `${savingsRate}%`;
        document.getElementById('totalIncome').textContent = `${income.toLocaleString('ru-RU')} ‚ÇΩ`;
        document.getElementById('totalExpenses').textContent = `${expenses.toLocaleString('ru-RU')} ‚ÇΩ`;
        document.getElementById('totalSavings').textContent = `${db.savings.toLocaleString('ru-RU')} ‚ÇΩ`;
        document.getElementById('savingsRate').textContent = `${savingsRate}%`;
        
        // Update chart - group by day for week, by month for year
        const ctx = document.getElementById('financeChart').getContext('2d');
        if(window.financeChart) window.financeChart.destroy();
        
        let labels, incomeData, expenseData;
        
        if(db.timeFilter === 'week') {
            labels = ['–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë', '–í–°'];
            incomeData = Array(7).fill(0);
            expenseData = Array(7).fill(0);
            
            filteredTxs.forEach(tx => {
                const txDate = new Date(tx.fullDate || tx.date);
                const dayIndex = txDate.getDay();
                const adjustedIndex = dayIndex === 0 ? 6 : dayIndex - 1;
                
                if(tx.type === 'inc') {
                    incomeData[adjustedIndex] += tx.val;
                } else {
                    expenseData[adjustedIndex] += tx.val;
                }
            });
        } else {
            // For month and year, show income vs expenses
            labels = ['–î–æ—Ö–æ–¥', '–†–∞—Å—Ö–æ–¥'];
            incomeData = [income, 0];
            expenseData = [0, expenses];
        }
        
        window.financeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '–î–æ—Ö–æ–¥—ã',
                        data: incomeData,
                        backgroundColor: '#10b981',
                        borderRadius: 6,
                    },
                    {
                        label: '–†–∞—Å—Ö–æ–¥—ã',
                        data: expenseData,
                        backgroundColor: '#ef4444',
                        borderRadius: 6,
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'top' } },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: 'rgba(255,255,255,0.05)' }, 
                        ticks: { color: '#94a3b8' }
                    },
                    x: { 
                        grid: { display: false }, 
                        ticks: { color: '#94a3b8' }
                    }
                }
            }
        });
    }

    // --- RENDER FUNCTIONS ---
    function render() {
        if(!db.setup) return;
        
        renderTasks();
        renderHabits();
        renderFinance();
        
        if(db.insightType === 'habits') {
            renderHabitsInsights();
        } else {
            renderFinanceInsights();
        }
    }

    function renderFinance() {
        // Calculate daily budget
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        
        let targetDate = new Date(db.salaryDate);
        targetDate.setHours(0, 0, 0, 0);
        
        const diffTime = targetDate - now;
        let daysRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if(daysRemaining < 1) daysRemaining = 1;
        
        const todayStr = new Date().toLocaleDateString('ru-RU');
        const spentToday = db.txs
            .filter(tx => tx.date === todayStr && tx.type === 'exp')
            .reduce((acc, tx) => acc + tx.val, 0);
        
        const virtualBalance = db.balance + spentToday;
        const dailyLimit = Math.floor(virtualBalance / daysRemaining);
        const availableNow = dailyLimit - spentToday;
        
        // Update header
        const dateFormatted = targetDate.toLocaleDateString('ru-RU', {day: 'numeric', month: 'long'});
        document.getElementById('salaryDateText').textContent = `–¥–æ ${dateFormatted} (${daysRemaining} –¥–Ω)`;
        document.getElementById('dailyVal').textContent = `${Math.floor(availableNow).toLocaleString('ru-RU')} ‚ÇΩ`;
        document.getElementById('saveVal').textContent = `${db.savings.toLocaleString('ru-RU')} ‚ÇΩ`;
        document.getElementById('fixVal').textContent = `${db.fixedCurrent.toLocaleString('ru-RU')} / ${db.fixedTarget.toLocaleString('ru-RU')} ‚ÇΩ`;
        
        // Fixed tasks
        const fixedTasksList = document.getElementById('fixedTasksList');
        if(db.fixedTasks.length > 0) {
            fixedTasksList.innerHTML = db.fixedTasks.map(task => `
                <div class="glass-panel animate-enter" style="display:flex; justify-content:space-between; align-items:center; padding:12px; margin-bottom:8px;">
                    <div>
                        <div style="font-weight:700; font-size:14px;">${task.name}</div>
                        <div style="font-size:10px; color:var(--text-muted);">${task.amount.toLocaleString('ru-RU')} ‚ÇΩ</div>
                    </div>
                    <button onclick="payFixed(${task.id}, ${task.amount})" style="background:var(--success); border:none; color:black; padding:6px 12px; border-radius:8px; font-weight:700; font-size:11px; cursor: pointer;">‚úì –û–ø–ª–∞—Ç–∏—Ç—å</button>
                </div>
            `).join('');
        } else {
            fixedTasksList.innerHTML = '<div style="text-align:center; color:var(--text-muted); font-size:12px; padding:20px;">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞</div>';
        }
        
        // Transaction history
        let filteredTxs = db.txs;
        if(currentFilter === 'INC') filteredTxs = db.txs.filter(t => t.type === 'inc');
        if(currentFilter === 'EXP') filteredTxs = db.txs.filter(t => t.type === 'exp');
        
        const txList = document.getElementById('txList');
        if(filteredTxs.length > 0) {
            txList.innerHTML = filteredTxs.slice(0, 15).map(tx => `
                <div class="tx-row" id="tx-${tx.id}">
                    <div class="tx-category">
                        <div class="tx-icon ${tx.type === 'inc' ? 'income' : 'expense'}">
                            ${tx.type === 'inc' ? '‚Üë' : '‚Üì'}
                        </div>
                        <div class="tx-details">
                            <div style="font-weight:700; font-size:14px;">${tx.cat}</div>
                            <div style="font-size:10px; color:var(--text-muted);">${tx.date} ${tx.t}</div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="tx-amount ${tx.type === 'inc' ? 'positive' : 'negative'}">
                            ${tx.type === 'inc' ? '+' : '-'}${tx.val.toLocaleString('ru-RU')} ‚ÇΩ
                        </div>
                        <button onclick="deleteTx(${tx.id})" class="tx-delete">‚úï</button>
                    </div>
                </div>
            `).join('');
        } else {
            txList.innerHTML = '<div style="text-align:center; color:var(--text-muted); font-size:12px; padding:30px;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>';
        }
    }

    // --- UI UTILITIES ---
    function switchTab(id, el) {
        // Update navigation
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        el.classList.add('active');
        
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected tab
        const targetTab = document.getElementById(`tab-${id}`);
        targetTab.classList.add('active');
        
        // Trigger animations
        setTimeout(() => {
            targetTab.querySelectorAll('.animate-enter').forEach((element, index) => {
                element.style.animationDelay = `${index * 0.1}s`;
                element.style.animation = 'none';
                setTimeout(() => {
                    element.style.animation = '';
                }, 10);
            });
        }, 10);
        
        // Render specific content
        if(id === 'ins') {
            if(db.insightType === 'habits') {
                renderHabitsInsights();
            } else {
                renderFinanceInsights();
            }
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
        // Clear inputs
        document.querySelectorAll(`#${modalId} .modal-input`).forEach(input => {
            input.value = '';
        });
    }

    function showResetModal() {
        document.getElementById('resetModal').classList.remove('hidden');
    }

    function hardReset() {
        if(confirm("–í–°–ï –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ. –í—ã —É–≤–µ—Ä–µ–Ω—ã?")) {
            localStorage.removeItem('lifeos_v13_pure');
            location.reload();
        }
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        load();
        
        // Initialize today's date
        const today = new Date();
        const options = { weekday: 'short', day: 'numeric', month: 'short' };
        document.getElementById('todayDate').textContent = today.toLocaleDateString('ru-RU', options);
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.classList.add('hidden');
                });
            }
        });
    });
</script>
</body>
</html>
