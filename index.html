<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeOS Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #000000;
            --card-bg: rgba(28, 28, 30, 0.6);
            --card-border: rgba(255, 255, 255, 0.08);
            --primary: #32d74b; /* Apple Green */
            --primary-glow: rgba(50, 215, 75, 0.3);
            --danger: #ff453a;
            --text-main: #ffffff;
            --text-sec: #8e8e93;
            --radius: 20px;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 80px; /* –ß—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª –∫ –Ω–∏–∑—É */
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }

        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        h1 { font-size: 28px; font-weight: 700; margin: 0; letter-spacing: -0.5px; }
        .date-badge { font-size: 14px; color: var(--text-sec); font-weight: 500; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        /* –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–ª–æ–∫ */
        .money-display { text-align: center; margin: 10px 0 20px 0; }
        .money-value { font-size: 42px; font-weight: 800; letter-spacing: -1px; text-shadow: 0 0 20px var(--primary-glow); }
        .money-label { color: var(--text-sec); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
        .progress-track { background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px var(--primary-glow); }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn {
            border: none; padding: 14px; border-radius: 14px; font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-danger { background: rgba(255, 69, 58, 0.15); color: var(--danger); border: 1px solid rgba(255, 69, 58, 0.3); }

        /* –°–µ–∫—Ü–∏—è –ø—Ä–∏–≤—ã—á–µ–∫ */
        .section-title { font-size: 18px; font-weight: 600; margin: 30px 0 12px 0; display: flex; justify-content: space-between; align-items: center; }
        .add-btn { background: #1c1c1e; border: 1px solid var(--card-border); color: var(--primary); width: 32px; height: 32px; border-radius: 50%; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .habit-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: rgba(255,255,255,0.03); border-radius: 16px; margin-bottom: 8px;
            transition: all 0.3s; border: 1px solid transparent;
        }
        .habit-info { display: flex; flex-direction: column; }
        .habit-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
        .habit-stats { font-size: 12px; color: var(--text-sec); }
        
        .checkbox {
            width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--text-sec);
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s;
        }
        .habit-item.done { border-color: rgba(50, 215, 75, 0.2); background: rgba(50, 215, 75, 0.05); }
        .habit-item.done .checkbox { background: var(--primary); border-color: var(--primary); box-shadow: 0 0 10px var(--primary-glow); }
        .habit-item.done .habit-name { text-decoration: line-through; color: var(--text-sec); }

        /* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–°–∫—Ä—ã—Ç–∞—è) */
        #addHabitForm { display: none; background: #1c1c1e; padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 1px solid var(--card-border); }
        .input-field { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 10px; margin-bottom: 12px; outline: none; font-size: 16px; box-sizing: border-box; }
        
        /* –í—ã–±–æ—Ä –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ */
        .week-selector { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .day-option {
            width: 36px; height: 36px; border-radius: 50%; background: #2c2c2e; color: #8e8e93;
            display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid transparent;
        }
        .day-option.selected { background: var(--primary); color: #000; box-shadow: 0 0 8px var(--primary-glow); }

        /* –ì—Ä–∞—Ñ–∏–∫ */
        canvas { width: 100% !important; height: 180px !important; }
    </style>
</head>
<body>

    <header class="fade-in">
        <div>
            <div class="date-badge" id="currentDate">loading...</div>
            <h1 id="greeting">LifeOS</h1>
        </div>
        <div style="width: 40px; height: 40px; background: #1c1c1e; border-radius: 50%; display: flex; align-items: center; justify-content: center;">üë§</div>
    </header>

    <div class="card fade-in" style="animation-delay: 0.1s;">
        <div class="money-display">
            <div class="money-label">–°–µ–≥–æ–¥–Ω—è –º–æ–∂–Ω–æ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å</div>
            <div class="money-value" id="dailyLimit">0 ‚ÇΩ</div>
        </div>
        
        <div class="progress-track">
            <div class="progress-fill" id="moneyBar" style="width: 100%;"></div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:12px; color:var(--text-sec);">
            <span id="spentInfo">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: 0</span>
            <span id="streakInfo">üî• –°—Ç—Ä–∏–∫: 0</span>
        </div>

        <div class="action-grid">
            <button class="btn btn-primary" onclick="markBudgetOK()">
                ‚úÖ –í –±—é–¥–∂–µ—Ç–µ
            </button>
            <button class="btn btn-danger" onclick="addExpense()">
                üí∏ –†–∞—Å—Ö–æ–¥
            </button>
        </div>
    </div>

    <div class="section-title fade-in" style="animation-delay: 0.2s;">
        <span>üéØ –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</span>
        <button class="add-btn" onclick="toggleAddForm()">+</button>
    </div>

    <div id="addHabitForm" class="fade-in">
        <input type="text" id="newHabitName" class="input-field" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë–µ–≥)">
        <div style="color: var(--text-sec); font-size: 12px; margin-bottom: 8px;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏:</div>
        <div class="week-selector" id="daySelector">
            </div>
        <button class="btn btn-primary" style="width:100%" onclick="saveNewHabit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</button>
    </div>

    <div id="habitsList" class="fade-in" style="animation-delay: 0.3s;">
        <div style="text-align: center; color: var(--text-sec); padding: 20px;">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–¥–∞—á –Ω–µ—Ç</div>
    </div>

    <div class="card fade-in" style="animation-delay: 0.4s; margin-top: 24px;">
        <div class="money-label" style="margin-bottom: 10px;">–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ (30 –¥–Ω–µ–π)</div>
        <canvas id="chart"></canvas>
    </div>

<script>
    // --- 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = tg.initDataUnsafe?.user;
    if(user) document.getElementById('greeting').innerText = `–ü—Ä–∏–≤–µ—Ç, ${user.first_name}`;

    // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –¥–ª—è UI
    const daysShort = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
    const todayIndex = new Date().getDay(); // 0 = –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
    
    document.getElementById('currentDate').innerText = new Date().toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });

    // --- 2. State (–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ) ---
    let appData = {
        balance: 30000, // –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –º–µ—Å—è—Ü
        dailyLimit: 1500, // –õ–∏–º–∏—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
        spentToday: 0,
        streak: 0,
        lastStreakDate: null,
        habits: [], // { id, name, days: [1,3,5], completions: { '2023-10-01': true } }
        history: [50, 60, 45, 70, 80, 75] // –§–µ–π–∫ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞
    const saved = localStorage.getItem('lifeOS_v2');
    if(saved) appData = JSON.parse(saved);

    // --- 3. –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–≤—ã—á–µ–∫ ---
    
    // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–Ω–æ–ø–æ–∫ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
    const daySelector = document.getElementById('daySelector');
    let selectedDays = [];
    
    // –ü–Ω(1) -> –°–±(6) -> –í—Å(0) - –º–µ–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –¥–ª—è –†–æ—Å—Å–∏–∏
    const displayOrder = [1, 2, 3, 4, 5, 6, 0]; 

    displayOrder.forEach(dayIdx => {
        const d = document.createElement('div');
        d.className = 'day-option';
        d.innerText = daysShort[dayIdx];
        d.onclick = () => {
            d.classList.toggle('selected');
            if(selectedDays.includes(dayIdx)) {
                selectedDays = selectedDays.filter(x => x !== dayIdx);
            } else {
                selectedDays.push(dayIdx);
            }
        };
        daySelector.appendChild(d);
    });

    function toggleAddForm() {
        const form = document.getElementById('addHabitForm');
        form.style.display = form.style.display === 'block' ? 'none' : 'block';
    }

    function saveNewHabit() {
        const name = document.getElementById('newHabitName').value;
        if(!name || selectedDays.length === 0) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏');
        
        appData.habits.push({
            id: Date.now(),
            name: name,
            days: selectedDays,
            completions: {} 
        });
        
        saveData();
        renderHabits();
        toggleAddForm();
        document.getElementById('newHabitName').value = '';
        // –°–±—Ä–æ—Å –¥–Ω–µ–π
        document.querySelectorAll('.day-option').forEach(el => el.classList.remove('selected'));
        selectedDays = [];
    }

    function toggleHabitDone(id) {
        const habit = appData.habits.find(h => h.id === id);
        const todayKey = new Date().toDateString();
        
        if (habit.completions[todayKey]) {
            delete habit.completions[todayKey];
        } else {
            habit.completions[todayKey] = true;
            tg.HapticFeedback.impactOccurred('light');
        }
        saveData();
        renderHabits();
    }

    function renderHabits() {
        const list = document.getElementById('habitsList');
        list.innerHTML = '';
        const todayKey = new Date().toDateString();

        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–∏–≤—ã—á–∫–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ –°–ï–ì–û–î–ù–Ø
        const todayHabits = appData.habits.filter(h => h.days.includes(todayIndex));

        if (todayHabits.length === 0) {
            list.innerHTML = `<div style="text-align: center; color: var(--text-sec); padding: 20px;">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–¥–∞—á –Ω–µ—Ç. –û—Ç–¥—ã—Ö–∞–π! üò¥</div>`;
            return;
        }

        todayHabits.forEach(h => {
            const isDone = !!h.completions[todayKey];
            
            // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
            let weekCount = 0;
            for(let i=0; i<7; i++) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                if(h.completions[d.toDateString()]) weekCount++;
            }

            const html = `
            <div class="habit-item ${isDone ? 'done' : ''}" onclick="toggleHabitDone(${h.id})">
                <div class="habit-info">
                    <div class="habit-name">${h.name}</div>
                    <div class="habit-stats">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ: ${weekCount}</div>
                </div>
                <div class="checkbox">
                    ${isDone ? '‚úî' : ''}
                </div>
            </div>
            `;
            list.innerHTML += html;
        });
    }

    // --- 4. –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –õ–æ–≥–∏–∫–∞ ---
    
    function updateFinanceUI() {
        const left = appData.dailyLimit - appData.spentToday;
        document.getElementById('dailyLimit').innerText = `${left} ‚ÇΩ`;
        document.getElementById('spentInfo').innerText = `–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${appData.spentToday} ‚ÇΩ`;
        document.getElementById('streakInfo').innerText = `üî• –°—Ç—Ä–∏–∫: ${appData.streak}`;

        // –ë–∞—Ä
        const percent = Math.max(0, (left / appData.dailyLimit) * 100);
        const bar = document.getElementById('moneyBar');
        bar.style.width = `${percent}%`;
        
        if(percent < 20) bar.style.background = '#ff453a'; // –ö—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ –º–∞–ª–æ
        else bar.style.background = '#32d74b'; // –ó–µ–ª–µ–Ω—ã–π
    }

    function addExpense() {
        tg.showPopup({
            title: '–†–∞—Å—Ö–æ–¥',
            message: '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ç—Ä–∞—Ç—ã:',
            buttons: [{id: 'save', type: 'ok'}]
        }, () => {
             // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –Ω—É–∂–µ–Ω –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –∏–Ω–ø—É—Ç
             // –î–ª—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º prompt (–Ω–æ –≤ –≤–µ–±–µ TG –æ–Ω –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–æ—Å—Ç–æ)
             let amount = prompt("–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞:");
             if(amount && !isNaN(amount)) {
                 appData.spentToday += parseInt(amount);
                 saveData();
                 updateFinanceUI();
             }
        });
    }

    function markBudgetOK() {
        tg.HapticFeedback.notificationOccurred('success');
        
        // –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–∏–∫–∞
        const today = new Date().toDateString();
        if(appData.lastStreakDate !== today) {
            appData.streak++;
            appData.lastStreakDate = today;
            saveData();
            updateFinanceUI();
            
            tg.showPopup({ title: '–ö—Ä–∞—Å–∞–≤—á–∏–∫!', message: '–î–µ–Ω—å –∑–∞–∫—Ä—ã—Ç —É—Å–ø–µ—à–Ω–æ. –°—Ç—Ä–∏–∫ —É–≤–µ–ª–∏—á–µ–Ω.' });
        } else {
             tg.showPopup({ title: '–£–∂–µ –æ—Ç–º–µ—á–µ–Ω–æ', message: '–¢—ã —Å–µ–≥–æ–¥–Ω—è —É–∂–µ –º–æ–ª–æ–¥–µ—Ü.' });
        }
    }

    // --- 5. –ì—Ä–∞—Ñ–∏–∫ ---
    function drawChart() {
        const ctx = document.getElementById('chart').getContext('2d');
        // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        let gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(50, 215, 75, 0.5)');
        gradient.addColorStop(1, 'rgba(50, 215, 75, 0)');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['1', '5', '10', '15', '20', '25'],
                datasets: [{
                    label: 'Score',
                    data: appData.history,
                    borderColor: '#32d74b',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.4 // –ü–ª–∞–≤–Ω—ã–µ –ª–∏–Ω–∏–∏
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { display: false }
                }
            }
        });
    }

    function saveData() {
        localStorage.setItem('lifeOS_v2', JSON.stringify(appData));
    }

    // –ó–∞–ø—É—Å–∫
    updateFinanceUI();
    renderHabits();
    drawChart();

</script>
</body>
</html>
