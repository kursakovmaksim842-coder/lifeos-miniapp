<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LifeOS Identity v14</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #000000;
            --surface: #121214;
            --border: rgba(255, 255, 255, 0.08);
            --primary: #FFFFFF;
            --sec: #8E8E93;
            --accent: #0A84FF;
            --success: #32D74B;
            --danger: #FF453A;
            --radius: 24px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg); color: var(--primary); font-family: 'Inter', sans-serif;
            margin: 0; padding: 0; min-height: 100vh; overflow-x: hidden;
        }

        /* Анимации */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .fade-in { animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .tx-item.deleting { transform: translateX(100%); opacity: 0; }

        .container { padding: 20px 20px 100px 20px; max-width: 500px; margin: 0 auto; display: none; }
        .container.active { display: block; }

        .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 12px; }
        .sub-text { color: var(--sec); font-size: 13px; font-weight: 500; }
        .hero-num { font-size: 44px; font-weight: 800; letter-spacing: -2px; margin: 8px 0; }

        /* Кнопки */
        .btn-flex { display: flex; gap: 10px; margin: 15px 0; }
        .btn { 
            flex: 1; padding: 16px; border-radius: 18px; border: none; font-size: 16px; font-weight: 600;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;
        }
        .btn:active { transform: scale(0.96); opacity: 0.8; }
        .btn-main { background: var(--primary); color: #000; }
        .btn-sec { background: rgba(255,255,255,0.05); color: var(--primary); border: 1px solid var(--border); }

        /* Навигация периодов в привычках */
        .period-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .period-chips { display: flex; gap: 8px; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 12px; }
        .chip { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; color: var(--sec); cursor: pointer; }
        .chip.active { background: var(--primary); color: #000; }

        /* Прогресс бар */
        .progress-container { height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); transition: width 0.5s ease; }

        /* Привычки */
        .habit-card { display: flex; flex-direction: column; gap: 12px; }
        .habit-header { display: flex; justify-content: space-between; align-items: center; }
        .bubbles { display: flex; justify-content: space-between; gap: 4px; }
        .bubble { 
            width: 36px; height: 36px; border-radius: 10px; background: rgba(255,255,255,0.05); 
            display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: var(--sec);
            transition: 0.2s;
        }
        .bubble.active { background: var(--accent); color: #fff; }
        .bubble.future { opacity: 0.2; pointer-events: none; }

        /* Нижнее меню */
        .nav {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            background: rgba(18, 18, 20, 0.8); backdrop-filter: blur(20px);
            padding: 8px; border-radius: 40px; border: 1px solid var(--border);
            display: flex; gap: 5px; z-index: 1000;
        }
        .nav-item { padding: 10px 20px; border-radius: 30px; color: var(--sec); font-size: 12px; font-weight: 600; transition: 0.3s; }
        .nav-item.active { background: var(--primary); color: #000; }

        #historySection { display: none; margin-top: 15px; }
        .tx-item { display: flex; justify-content: space-between; padding: 14px; background: rgba(255,255,255,0.03); border-radius: 16px; margin-bottom: 8px; }
    </style>
</head>
<body>

    <div id="view-fin" class="container active fade-in">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div class="sub-text" id="salaryLabel" onclick="changeSalaryDate()" style="cursor: pointer;">До зарплаты ... ▾</div>
            <div style="font-size: 11px; font-weight: 700; color: var(--accent);">IDENTITY PREMIUM</div>
        </div>

        <div class="sub-text">Доступно на день</div>
        <div class="hero-num" id="dailyVal">0 ₽</div>
        <div class="sub-text" id="totalCap" style="margin-top: -5px; opacity: 0.6;">Всего: 0 ₽</div>

        <div class="btn-flex">
            <button class="btn btn-sec" onclick="addIncome()">+ Доход</button>
            <button class="btn btn-main" onclick="addExpense()">- Трата</button>
        </div>

        <center>
            <button class="sub-text" style="background:none; border:none; padding:10px;" onclick="toggleHistory()">История операций ▾</button>
        </center>

        <div id="historySection">
            <div id="txList"></div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
            <div class="card" style="margin:0;">
                <div class="sub-text">Сейф (20%)</div>
                <div style="font-size: 18px; font-weight: 700; margin-top: 4px;" id="safeVal">0 ₽</div>
            </div>
            <div class="card" style="margin:0;" onclick="manageFixed()">
                <div class="sub-text">Счета ▾</div>
                <div style="font-size: 18px; font-weight: 700; margin-top: 4px;" id="fixedVal">0 / 0</div>
            </div>
        </div>
    </div>

    <div id="view-hab" class="container fade-in">
        <div class="period-nav">
            <h2 style="font-size: 24px; font-weight: 800; margin:0;">Дисциплина</h2>
            <div class="period-chips">
                <div class="chip active">День</div>
                <div class="chip">Неделя</div>
                <div class="chip">Месяц</div>
            </div>
        </div>

        <div class="card">
            <div class="habit-header">
                <span class="sub-text">Индекс выполнения</span>
                <span id="progressText" style="font-weight: 700; font-size: 13px;">0 / 0</span>
            </div>
            <div class="progress-container"><div id="progressFill" class="progress-fill" style="width: 0%"></div></div>
        </div>

        <div id="habitsList"></div>
        <button class="btn btn-sec" style="width: 100%; margin-top: 10px;" onclick="addNewHabit()">+ Добавить привычку</button>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="switchTab('fin', this)">Финансы</div>
        <div class="nav-item" onclick="switchTab('hab', this)">Привычки</div>
    </div>

    <input type="date" id="salaryPicker" style="position:fixed; opacity:0; pointer-events:none;">

<script>
    let db = {
        balance: 0,
        savings: 0,
        fixedTarget: 0,
        fixedPaid: 0,
        salaryDate: new Date(Date.now() + 864000000).toISOString().split('T')[0],
        txs: [],
        habits: []
    };

    function init() {
        const saved = localStorage.getItem('lifeos_v14');
        if(saved) db = JSON.parse(saved);
        render();
    }

    function save() {
        localStorage.setItem('lifeos_v14', JSON.stringify(db));
        render();
    }

    // --- ФИНАНСЫ ---
    function addIncome() {
        const val = +prompt("Сумма дохода:");
        if(!val) return;
        
        const toSave = Math.floor(val * 0.2);
        const toFixed = Math.min(val - toSave, Math.max(0, db.fixedTarget - db.fixedPaid));
        const toBal = val - toSave - toFixed;

        db.savings += toSave;
        db.fixedPaid += toFixed;
        db.balance += toBal;

        db.txs.unshift({
            id: Date.now(),
            type: 'inc',
            val: val,
            split: { s: toSave, f: toFixed, b: toBal },
            date: new Date().toLocaleDateString()
        });
        save();
    }

    function addExpense() {
        const val = +prompt("Сумма расхода:");
        if(!val) return;
        const desc = prompt("На что?");
        db.balance -= val;
        db.txs.unshift({ id: Date.now(), type: 'exp', val: val, desc: desc || 'Расход', date: new Date().toLocaleDateString() });
        save();
    }

    function deleteTx(id, el) {
        el.classList.add('deleting');
        setTimeout(() => {
            const idx = db.txs.findIndex(t => t.id === id);
            const t = db.txs[idx];
            if(t.type === 'inc') {
                // Корректный откат: вычитаем ровно столько, сколько было распределено
                db.savings -= (t.split.s || 0);
                db.fixedPaid -= (t.split.f || 0);
                db.balance -= (t.split.b || 0);
            } else {
                db.balance += t.val;
            }
            db.txs.splice(idx, 1);
            save();
        }, 300);
    }

    function changeSalaryDate() {
        const p = document.getElementById('salaryPicker');
        p.showPicker();
        p.onchange = (e) => { db.salaryDate = e.target.value; save(); };
    }

    function manageFixed() {
        const val = +prompt("Установить цель по счетам (мес):", db.fixedTarget);
        if(val !== null) { db.fixedTarget = val; save(); }
    }

    // --- ПРИВЫЧКИ ---
    function addNewHabit() {
        const name = prompt("Название привычки (глаголом):");
        if(name) {
            db.habits.push({ id: Date.now(), name, done: [] });
            save();
        }
    }

    function toggleHabit(id, dateStr) {
        const h = db.habits.find(x => x.id === id);
        if(h.done.includes(dateStr)) h.done = h.done.filter(d => d !== dateStr);
        else h.done.push(dateStr);
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        save();
    }

    function render() {
        // Финансы
        const days = Math.ceil((new Date(db.salaryDate) - new Date()) / (1000*3600*24)) || 1;
        document.getElementById('salaryLabel').innerText = `До зарплаты ${days} дн. ▾`;
        
        const daily = Math.floor(Math.max(0, db.balance) / days);
        document.getElementById('dailyVal').innerText = daily.toLocaleString() + ' ₽';
        document.getElementById('totalCap').innerText = `Всего: ${(db.balance + db.savings + db.fixedPaid).toLocaleString()} ₽`;
        document.getElementById('safeVal').innerText = db.savings.toLocaleString() + ' ₽';
        document.getElementById('fixedVal').innerText = `${db.fixedPaid.toLocaleString()} / ${db.fixedTarget.toLocaleString()}`;

        document.getElementById('txList').innerHTML = db.txs.map(t => `
            <div class="tx-item" onclick="deleteTx(${t.id}, this)">
                <div><div style="font-weight:600;">${t.type==='inc'?'Пополнение':t.desc}</div><div class="sub-text">${t.date}</div></div>
                <div style="font-weight:700; color:${t.type==='inc'?'var(--success)':'#fff'}">${t.type==='inc'?'+':'-'}${t.val}</div>
            </div>
        `).join('');

        // Привычки
        let totalDoneToday = 0;
        const todayStr = new Date().toLocaleDateString();
        
        document.getElementById('habitsList').innerHTML = db.habits.map(h => {
            const isDoneToday = h.done.includes(todayStr);
            if(isDoneToday) totalDoneToday++;
            
            // Генерация пузырьков недели
            let bubblesHtml = '';
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const ds = d.toLocaleDateString();
                const active = h.done.includes(ds) ? 'active' : '';
                const isToday = i === 0;
                bubblesHtml += `<div class="bubble ${active}" onclick="toggleHabit(${h.id}, '${ds}')">${d.getDate()}</div>`;
            }

            return `
                <div class="card habit-card">
                    <div class="habit-header">
                        <span style="font-weight:700;">${h.name}</span>
                        <span class="sub-text">${h.done.length} всего</span>
                    </div>
                    <div class="bubbles">${bubblesHtml}</div>
                </div>
            `;
        }).join('');

        const progress = db.habits.length ? (totalDoneToday / db.habits.length) * 100 : 0;
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressText').innerText = `${totalDoneToday} / ${db.habits.length}`;
    }

    function switchTab(tab, el) {
        document.querySelectorAll('.container').forEach(v => v.style.display = 'none');
        document.getElementById('view-'+tab).style.display = 'block';
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    function toggleHistory() {
        const s = document.getElementById('historySection');
        s.style.display = s.style.display === 'block' ? 'none' : 'block';
    }

    init();
</script>
</body>
</html>
